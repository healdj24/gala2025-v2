Yeah, did you use the local storage to track which emojis the current user has already reacted? Yeah, we'll use option 1 there. Let's do that.<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Gala 2025</title>
  <style>
    @font-face {
      font-family: 'Nagbuloe';
      src: url('./fonts/NEWnagbuloe-bold.otf') format('opentype');
      font-weight: bold;
      font-style: normal;
    }

    @font-face {
      font-family: 'Nagbuloe Outline';
      src: url('./fonts/NEWNagbuloe-ThinOutline.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      background: #ffffff;
      scroll-behavior: auto;
      overscroll-behavior-y: none;
      position: relative;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow-x: hidden;
      background: #ffffff;
      overscroll-behavior-y: none;
      position: relative;
    }

    /* White section at top - scrolls up like peeling layer */
    .white-section {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 100vh;
      background: #ffffff;
      z-index: 20;
      transform: translateY(0);
    }

    /* Orange section below - fixed underneath */
    .orange-section {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 100vh;
      background: #ff6b35;
      z-index: 1;
    }

    /* Spacer to allow scrolling through orange section and third section slide-up */
    .scroll-spacer {
      position: relative;
      height: 400vh; /* Creates enough scroll space: 100vh orange + 200vh for third section slide-up */
      z-index: 0;
    }

    /* Third orange section that slides up */
    .third-section {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100vh;
      background: #ff6b35;
      z-index: 150; /* Higher than hero container (100) to cover it */
      transform: translateY(100%); /* Start hidden below */
      /* No transition - will be controlled directly by scroll */
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start; /* Mobile: start from top so Details header is visible */
      padding: 1.5rem 1rem; /* Mobile: reduced padding */
      gap: 1.5rem;
      overflow-y: hidden; /* Disabled until section is fully visible */
      padding-top: 2rem; /* Ensure header is visible at top */
      touch-action: none; /* Prevent touch scrolling when not fully visible */
      pointer-events: auto; /* Allow clicks but not scrolling */
    }

    .third-section.scrollable {
      overflow-y: auto; /* Enable scrolling only when fully visible */
      touch-action: pan-y; /* Allow vertical scrolling when fully visible */
    }

    @media (min-width: 768px) {
      .third-section {
        flex-direction: row;
        align-items: center;
        justify-content: center; /* Desktop: center content */
        padding: 2rem;
        gap: 2rem;
      }
    }

    /* Left column: Details */
    .third-section-left {
      width: 100%;
      padding: 0; /* Mobile: remove padding, will add to inner elements */
      border: none;
      font-family: 'Nagbuloe', serif;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      justify-content: flex-start; /* Mobile: start from top */
      gap: 1rem; /* Reduced from 1.5rem for tighter spacing */
      text-align: left;
      align-items: flex-start;
    }

    @media (min-width: 768px) {
      .third-section-left {
        width: 50%;
        padding: 2rem;
        justify-content: center; /* Desktop: center content */
      }
    }

    .party-details-header {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 1.5rem; /* A bit bigger as it's a header */
      color: #ffffff;
      margin: 0;
      padding: 0 0.5rem; /* Mobile: add horizontal padding */
    }

    @media (min-width: 768px) {
      .party-details-header {
        font-size: 2rem;
        padding: 0; /* Desktop: remove padding */
      }
    }

    .party-details-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .party-details-list li {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 0.94rem;
      color: #ffffff;
      line-height: 1.5;
      position: relative;
      padding-left: 1.5rem;
    }

    .party-details-list li::before {
      content: "â€¢";
      position: absolute;
      left: 0;
      font-size: 1.2rem;
    }

    @media (min-width: 768px) {
      .party-details-list li {
        font-size: 1.2rem;
      }
    }

    /* Details icons and text */
    .details-icons {
      display: flex;
      flex-direction: column;
      gap: 0.735rem; /* Mobile: 30% smaller (1.05rem * 0.7) */
      margin-bottom: 0.7rem; /* Mobile: 30% smaller (1rem * 0.7) */
      text-align: left;
      width: 100%;
      padding: 0 0.5rem; /* Mobile: add horizontal padding */
    }

    @media (min-width: 768px) {
      .details-icons {
        padding: 0; /* Desktop: remove padding */
        gap: 1.05rem; /* Keep reduced gap on desktop too */
        margin-bottom: 1rem; /* Keep reduced margin on desktop */
      }
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 0.525rem; /* Mobile: 30% smaller (0.75rem * 0.7) */
      text-align: left;
    }

    .detail-icon {
      font-size: 1.05rem; /* Mobile: 30% smaller (1.5rem * 0.7) */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.05rem; /* Mobile: 30% smaller */
      height: 1.05rem; /* Mobile: 30% smaller */
      text-align: center;
      flex-shrink: 0;
    }

    .detail-icon svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    @media (min-width: 768px) {
      .detail-icon {
        font-size: 2rem;
        width: 2rem;
        height: 2rem;
      }

      .detail-item {
        gap: 0.75rem; /* Desktop: original gap */
      }
    }

    .detail-link {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 16px; /* Match input font size for consistency */
      color: #ffffff;
      text-decoration: underline;
      transition: opacity 0.2s ease;
    }

    .detail-link:hover {
      opacity: 0.8;
    }

    @media (min-width: 768px) {
      .detail-link {
        font-size: 1.2rem;
      }
    }

    .detail-text {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 16px; /* Match input font size for consistency */
      color: #ffffff;
    }

    @media (min-width: 768px) {
      .detail-text {
        font-size: 1.2rem;
      }
    }

    .details-paragraph {
      text-align: left;
      width: 100%;
      padding: 0 0.5rem; /* Mobile: add small horizontal padding */
    }

    .details-paragraph p {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 0.672rem; /* Mobile: 20% bigger (0.56rem * 1.2) */
      color: #ffffff;
      line-height: 1.4; /* Mobile: tighter line height */
      margin: 0 0 0.56rem 0; /* Mobile: reduced margin */
    }

    .details-paragraph p:last-child {
      margin-bottom: 0;
    }

    .details-paragraph a {
      color: #ffffff;
      text-decoration: underline;
      transition: opacity 0.2s ease;
    }

    .details-paragraph a:hover {
      opacity: 0.8;
    }

    @media (min-width: 768px) {
      .details-paragraph {
        padding: 0; /* Desktop: remove padding */
      }
      
      .details-paragraph p {
        font-size: 1.2rem; /* Desktop: larger text */
        line-height: 1.6;
        margin: 0 0 1rem 0;
      }
    }

    /* Right column: RSVP form */
    .third-section-right {
      width: 95%; /* Mobile: wider, close to edges */
      display: flex;
      flex-direction: column;
      justify-content: flex-start; /* Mobile: start from top */
      gap: 1.5rem;
      padding: 1.5rem; /* Mobile: reduced padding */
      border: 10px solid #ffffff;
      max-height: none; /* Mobile: remove max-height restriction */
      overflow-y: visible; /* Mobile: remove scroll */
      margin: 0 auto; /* Mobile: center the container */
    }

    @media (max-width: 767px) {
      .third-section-right {
        gap: 1rem; /* 35% smaller: 1.5rem * 0.65 */
        padding: 1rem; /* 35% smaller: 1.5rem * 0.65 */
        border-width: 7px; /* 35% smaller: 10px * 0.65 */
      }
    }

    @media (min-width: 768px) {
      .third-section-right {
        width: 40%;
        padding: 2rem;
        max-height: calc((100vh - 4rem) * 0.8);
        overflow-y: auto;
        overflow-x: visible; /* Allow picker to show horizontally */
        margin-right: 6rem; /* Ensure space for play button (2rem + 60px + 2rem buffer) */
        justify-content: center; /* Desktop: center content */
      }
    }

    /* RSVP button on third page */
    .third-page-rsvp {
      padding: 0.5rem 1.2rem; /* Increased padding to accommodate larger text */
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 1.5rem; /* Match party-details-header mobile size */
      color: #ffffff;
      background: #ff6b35;
      border: 2px solid #ffffff; /* White border on orange background */
      border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
      cursor: pointer;
      user-select: none;
      text-transform: uppercase;
      opacity: 0; /* Start invisible */
      transition: opacity 1s ease; /* Fade in over 1 second */
      pointer-events: auto !important; /* Ensure button is always clickable */
      position: relative;
      z-index: 1000; /* High z-index to ensure it's on top */
      align-self: flex-start; /* Align to top of right column */
    }

    @media (max-width: 767px) {
      .third-page-rsvp {
        padding: 0.325rem 0.78rem; /* 35% smaller */
        font-size: 1.17rem; /* 20% bigger (0.975rem * 1.2) */
        border-width: 1.3px; /* 35% smaller */
      }
    }

    .third-page-rsvp.visible {
      opacity: 1;
    }

    .third-page-rsvp:hover {
      opacity: 0.8;
    }

    @media (min-width: 768px) {
      .third-page-rsvp {
        padding: 0.8rem 2rem; /* Increased padding for desktop */
        font-size: 2rem; /* Match party-details-header desktop size */
      }
    }

    /* Guest list container - always visible */
    .guest-list-container {
      font-family: 'Nagbuloe', serif;
      color: #ffffff;
      width: 100%; /* Mobile: full width */
      overflow: visible; /* Allow picker to show above */
    }

    @media (min-width: 768px) {
      .guest-list-container {
        width: auto; /* Desktop: auto width */
        overflow: visible; /* Allow picker to show above */
      }
    }

    .guest-list-header {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 1.2rem;
      color: #ffffff;
      margin: 0 0 1rem 0;
    }

    @media (max-width: 767px) {
      .guest-list-header {
        font-size: 1.5rem; /* A bit bigger as it's a header */
        margin: 0 0 0.65rem 0; /* 35% smaller */
      }
    }

    @media (min-width: 768px) {
      .guest-list-header {
        font-size: 1.5rem;
      }
    }

    /* RSVP form container */
    .rsvp-form-container {
      font-family: 'Nagbuloe', serif;
      color: #ffffff;
      max-height: calc(100vh - 20rem);
      overflow-y: auto;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    @media (max-width: 767px) {
      .rsvp-form-container {
        max-height: calc(100vh - 13rem); /* 35% smaller adjustment */
      }
    }

    .rsvp-content {
      font-family: 'Nagbuloe', serif;
      font-size: 1rem;
      color: #ffffff;
      line-height: 1.6;
    }

    @media (max-width: 767px) {
      .rsvp-content {
        font-size: 0.65rem; /* 35% smaller: 1rem * 0.65 */
        line-height: 1.4; /* Slightly tighter */
      }
    }

    .nav-item:hover {
      opacity: 0.8;
    }

    .nav-item:active {
      opacity: 0.6;
    }

    /* Modal/Popup Styles */
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ff6b35;
      border: 5px solid #ffffff;
      z-index: 2000;
      display: none; /* Hidden by default */
      padding: 2rem;
      cursor: move; /* Shows that it's draggable */
      touch-action: none; /* Prevents default touch scrolling during drag */
    }

    .modal.active {
      display: block;
    }

    /* Details modal sizing */
    .modal.details-modal {
      width: 80%;
      max-height: 70vh;
      overflow-y: auto;
    }

    @media (min-width: 768px) {
      .modal.details-modal {
        width: 30%;
      }
    }


    /* Modal header with close button */
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #ffffff;
    }

    .modal-title {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 2rem;
      color: #ffffff;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      color: #ffffff;
      font-size: 2.5rem;
      line-height: 1;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease;
      font-family: Arial, sans-serif;
      font-weight: 300;
    }

    .modal-close:hover {
      opacity: 0.7;
    }

    /* Modal content */
    .modal-content {
      font-family: 'Nagbuloe', serif;
      font-size: 1rem;
      color: #ffffff;
      line-height: 1.6;
      max-height: calc(70vh - 120px); /* Subtract header height */
      overflow-y: auto; /* Enable scrolling */
      padding-right: 0.5rem; /* Space for scrollbar */
    }

    /* Custom white scrollbar for modal content */
    .modal-content::-webkit-scrollbar {
      width: 8px;
    }

    .modal-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }

    .modal-content::-webkit-scrollbar-thumb {
      background: #ffffff;
      border-radius: 4px;
    }

    .modal-content::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .modal-content p {
      margin-bottom: 1rem;
    }

    /* RSVP form styles */
    .rsvp-form {
      margin-bottom: 2rem;
    }

    @media (max-width: 767px) {
      .rsvp-form {
        margin-bottom: 1.3rem; /* 35% smaller: 2rem * 0.65 */
      }

      /* Reduce spacing in RSVP steps */
      .rsvp-step input#emailInput {
        margin-top: 0.65rem !important; /* 35% smaller: 1rem * 0.65 */
      }

      .rsvp-step > div[style*="display: flex"] {
        gap: 0.325rem !important; /* 35% smaller: 0.5rem * 0.65 */
        margin-top: 0.65rem !important; /* 35% smaller */
        margin-bottom: 0.65rem !important; /* 35% smaller */
      }

      /* Reduce step 3 text sizes - override inline styles */
      .rsvp-step p {
        font-size: 0.715rem !important; /* 35% smaller: 1.1rem * 0.65 */
        margin-bottom: 0.65rem !important; /* 35% smaller */
        line-height: 1.3 !important;
      }

      .rsvp-step p:has(strong#ticketPrice) {
        font-size: 0.585rem !important; /* 35% smaller: 0.9rem * 0.65 */
        margin-bottom: 0.975rem !important; /* 35% smaller: 1.5rem * 0.65 */
      }

      .rsvp-step a#venmoPaymentLink {
        margin-bottom: 0.65rem !important; /* 35% smaller */
      }
    }

    .rsvp-input {
      width: 100%;
      padding: 0.68rem 1rem; /* 10% skinnier vertically (0.75 * 0.9) */
      font-family: 'Nagbuloe', serif;
      font-size: 1rem;
      border: 2px solid #ffffff;
      border-radius: 25px;
      background: #ffffff;
      color: #000000;
      margin-bottom: 0;
    }

    @media (max-width: 767px) {
      .rsvp-input {
        padding: 0.442rem 0.65rem; /* 35% smaller */
        font-size: 16px; /* Minimum 16px to prevent auto-zoom on mobile */
        border-width: 1.3px; /* 35% smaller */
        border-radius: 16px; /* 35% smaller: 25px * 0.65 */
      }
    }

    .rsvp-button {
      width: 100%;
      padding: 0.68rem 1rem; /* 10% skinnier vertically (0.75 * 0.9) */
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 1rem;
      border: 2px solid #ffffff;
      border-radius: 25px;
      background: #ffffff;
      color: #ff6b35;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    @media (max-width: 767px) {
      .rsvp-button {
        padding: 0.442rem 0.65rem; /* 35% smaller */
        font-size: 16px; /* Match input font size for consistency */
        border-width: 1.3px; /* 35% smaller */
        border-radius: 16px; /* 35% smaller: 25px * 0.65 */
      }
    }

    .rsvp-button:hover {
      opacity: 0.8;
    }

    /* Split buttons for "just me" / "plus one" */
    .rsvp-split-button {
      flex: 1;
      padding: 0.68rem 1rem;
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 1rem;
      border: 2px solid #ffffff;
      border-radius: 25px;
      background: #ff6b35;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: lowercase;
    }

    @media (max-width: 767px) {
      .rsvp-split-button {
        padding: 0.442rem 0.65rem; /* 35% smaller */
        font-size: 16px; /* Match input font size for consistency */
        border-width: 1.3px; /* 35% smaller */
        border-radius: 16px; /* 35% smaller: 25px * 0.65 */
      }
    }

    .rsvp-split-button:hover {
      opacity: 0.8;
    }

    .rsvp-split-button.selected {
      background: #ffffff;
      color: #ff6b35;
    }

    /* Venmo payment button - matches rsvp-button style */
    .venmo-button {
      width: 100%;
      padding: 0.68rem 1rem; /* Same as rsvp-button */
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 1rem;
      border: 2px solid #ffffff;
      border-radius: 25px;
      background: #3D95CE; /* Venmo blue instead of white */
      color: #ffffff;
      cursor: pointer;
      text-decoration: none;
      display: block;
      text-align: center;
      transition: opacity 0.2s ease;
    }

    @media (max-width: 767px) {
      .venmo-button {
        padding: 0.442rem 0.65rem; /* 35% smaller */
        font-size: 0.65rem; /* 35% smaller: 1rem * 0.65 */
        border-width: 1.3px; /* 35% smaller */
        border-radius: 16px; /* 35% smaller: 25px * 0.65 */
      }
    }

    .venmo-button:hover {
      opacity: 0.8;
    }

    /* Animated guest name in list */
    @keyframes nameFlicker {
      0%, 10%, 20%, 30%, 40%, 50%, 60%, 70%, 80%, 90%, 100% {
        font-family: 'Nagbuloe', serif;
        font-weight: bold;
      }
      5%, 15%, 25%, 35%, 45%, 55%, 65%, 75%, 85%, 95% {
        font-family: 'Nagbuloe Outline', serif;
        font-weight: normal;
      }
    }

    .guest-name-animated {
      animation: nameFlicker 2s ease-in-out;
    }

    .guest-list {
      margin-top: 1.5rem;
    }

    .guest-list-title {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 1.5rem;
      color: #ffffff;
      margin-bottom: 1rem;
      text-align: center; /* Center to match the buttons */
    }

    @media (max-width: 767px) {
      .guest-list-title {
        font-size: 0.975rem; /* 35% smaller: 1.5rem * 0.65 */
        margin-bottom: 0.65rem; /* 35% smaller */
      }
    }

    .guest-list-items {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .guest-list-items li {
      padding: 0.75rem 0; /* Increased padding to accommodate larger badges (2em circle) */
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      white-space: nowrap; /* Prevent name from wrapping to two rows */
      overflow-x: hidden; /* Hide overflow emojis horizontally */
      overflow-y: visible; /* Allow picker to show above */
      font-size: 1.2rem; /* Match guest-list-header size */
      min-width: 0; /* Allow flex items to shrink */
    }
    
    /* Ensure name and reactions stay on one line */
    .guest-list-items li > span:first-child,
    .guest-list-items li > .guest-reactions {
      flex-shrink: 0; /* Don't shrink name or reactions */
    }
    
    .guest-list-items li > .guest-reactions {
      min-width: 0; /* Allow reactions to be cut off */
    }

    @media (max-width: 767px) {
      .guest-list-items li {
        padding: 0.49rem 0; /* Increased to accommodate larger badges (0.75rem * 0.65) */
        font-size: 16px; /* Match input font size for consistency */
      }
    }

    @media (min-width: 768px) {
      .guest-list-items li {
        font-size: 1.5rem; /* Match guest-list-header desktop size */
      }
    }

    /* Edit button styling */
    .edit-button {
      font-family: 'Nagbuloe', serif;
      font-size: 1.2rem; /* Match guest-list-header size */
      color: #ffffff;
      background: none;
      border: none;
      cursor: pointer;
      text-decoration: underline;
      opacity: 0;
      transition: opacity 0.5s ease;
      padding: 0;
      text-transform: lowercase;
      pointer-events: auto; /* Ensure clickable */
    }

    @media (max-width: 767px) {
      .edit-button {
        font-size: 0.78rem; /* 35% smaller: 1.2rem * 0.65 */
      }
    }

    @media (min-width: 768px) {
      .edit-button {
        font-size: 1.5rem; /* Match guest-list-header desktop size */
      }
    }

    .edit-button.visible {
      opacity: 1;
    }

    .edit-button:hover {
      opacity: 0.7;
    }

    /* Ensure edit container is clickable */
    .guest-list-items li > div {
      pointer-events: auto;
    }

    /* Edit options as plain text */
    .edit-options {
      display: none;
      align-items: center;
      gap: 0.3rem;
    }

    .edit-options.active {
      display: flex;
    }

    .edit-option-link {
      font-family: 'Nagbuloe', serif;
      font-size: 1.2rem; /* Match guest-list-header size */
      color: #ffffff;
      background: none;
      border: none;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      text-transform: lowercase;
    }

    @media (max-width: 767px) {
      .edit-option-link {
        font-size: 0.78rem; /* 35% smaller: 1.2rem * 0.65 */
      }
    }

    @media (min-width: 768px) {
      .edit-option-link {
        font-size: 1.5rem; /* Match guest-list-header desktop size */
      }
    }

    .edit-option-link:hover {
      opacity: 0.7;
    }

    .edit-separator {
      color: #ffffff;
      font-size: 1.2rem; /* Match guest-list-header size */
      opacity: 0.6;
    }

    @media (max-width: 767px) {
      .edit-separator {
        font-size: 0.78rem; /* 35% smaller: 1.2rem * 0.65 */
      }
    }

    @media (min-width: 768px) {
      .edit-separator {
        font-size: 1.5rem; /* Match guest-list-header desktop size */
      }
    }

    .guest-list-items li {
      position: relative;
    }

    /* Emoji reactions styling */
    .guest-reactions {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      margin-left: 0.5rem;
      flex-wrap: wrap; /* Allow wrapping if needed */
      overflow: visible; /* Show badges that extend outside */
      flex-shrink: 0; /* Don't shrink reactions container */
    }

    @media (max-width: 767px) {
      .guest-reactions {
        gap: 0.2rem; /* Smaller gap on mobile */
        margin-left: 0.325rem;
        overflow: visible; /* Show badges on mobile */
      }
    }

    .emoji-bubble {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border-radius: 0;
      width: auto;
      height: auto;
      padding: 0;
      cursor: pointer;
      transition: transform 0.2s ease;
      font-size: 1.2em; /* 20% bigger: 1em * 1.2 */
      line-height: 1;
    }

    .emoji-bubble:hover {
      transform: scale(1.1);
    }

    .emoji-bubble .emoji {
      font-size: 1em; /* Full size emoji */
      line-height: 1;
    }

    .emoji-count-badge {
      position: absolute;
      top: -0.5em; /* Position further onto top-right of emoji */
      right: -0.5em;
      background: #ffffff; /* White circle */
      color: #ff6b35; /* Orange number */
      border-radius: 50%;
      width: 2em; /* Larger circle - plenty of room for numbers */
      height: 2em; /* Larger circle - plenty of room for numbers */
      min-width: 2em; /* Ensure minimum size */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.55em; /* Smaller number size to fit comfortably */
      font-weight: bold;
      padding: 0; /* No padding - flexbox handles centering */
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1;
      box-sizing: border-box;
      text-align: center;
      /* Ensure the number doesn't overflow */
      overflow: visible;
    }

    .emoji-count-badge.hide {
      display: none; /* Hide when count is 1 */
    }

    /* Emoji picker popup */
    .emoji-picker {
      position: fixed; /* Use fixed to avoid overflow clipping */
      background: #ff6b35;
      border: 2px solid #ffffff;
      border-radius: 2rem; /* Pill shape */
      padding: 0.9rem 1.08rem; /* 20% bigger (0.75rem * 1.2, 0.9rem * 1.2) to accommodate top badges */
      display: none !important;
      flex-wrap: wrap;
      gap: 0.48rem; /* 20% bigger (0.4rem * 1.2) */
      z-index: 10000; /* Very high z-index to ensure it's on top */
      min-width: 9.6rem; /* 20% bigger (8rem * 1.2) */
      max-width: 14.4rem; /* 20% bigger (12rem * 1.2) */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      pointer-events: auto;
      transform: translateZ(0); /* Force hardware acceleration and create new stacking context */
      overflow: visible; /* Ensure badges aren't clipped */
    }

    .emoji-picker.active {
      display: flex !important;
    }

    @media (max-width: 767px) {
      .emoji-picker {
        padding: 0.6rem 0.78rem; /* 20% bigger (0.5rem * 1.2, 0.65rem * 1.2) */
        gap: 0.312rem; /* 20% bigger (0.26rem * 1.2) */
        min-width: 7.2rem; /* 20% bigger (6rem * 1.2) */
        max-width: 12rem; /* 20% bigger (10rem * 1.2) */
        border-width: 1.3px;
        overflow: visible; /* Ensure badges aren't clipped on mobile */
      }
    }

    .emoji-picker-emoji {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: transparent; /* Remove white background */
      border-radius: 0; /* Remove circle */
      width: auto; /* Auto width */
      height: auto; /* Auto height */
      padding: 0; /* Remove padding */
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.2s ease;
      font-size: 1.2em; /* Same size as name emojis - 20% bigger */
      line-height: 1;
      box-sizing: border-box;
    }

    /* Dim clicked emojis in picker */
    .emoji-picker-emoji.clicked {
      opacity: 0.5; /* Dim clicked emojis */
      cursor: default; /* Show it's not clickable */
      pointer-events: none; /* Prevent clicking */
    }

    .emoji-picker-emoji:hover:not(.clicked) {
      transform: scale(1.1);
    }

    .emoji-picker-emoji .emoji {
      font-size: 1em; /* Full size emoji */
      line-height: 1;
    }

    /* Guest name clickable area */
    .guest-name-clickable {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      text-decoration: none;
      color: inherit;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap; /* Prevent name from wrapping */
      flex-shrink: 0; /* Don't shrink the name */
    }

    .guest-name-clickable:active,
    .guest-name-clickable:focus,
    .guest-name-clickable:visited {
      color: inherit;
      text-decoration: none;
      outline: none;
    }

    /* Fixed hero content */
    .hero {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 100;
      pointer-events: none;
    }

    .small-text {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      font-size: 0.75rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #000;
      margin-bottom: 1rem;
      font-weight: 400;
      transition: color 0.3s ease;
    }

    .small-text.on-orange {
      color: #ffffff;
    }

    .main-title {
      font-family: 'Nagbuloe', serif;
      font-size: clamp(4rem, 15vw, 12rem);
      font-weight: normal;
      color: #000;
      margin: 0;
      line-height: 0.9;
      letter-spacing: -0.02em;
      font-variant-ligatures: none;
      font-kerning: none;
      transition: color 0.3s ease;
      display: inline-block;
      white-space: nowrap;
    }

    .main-title.on-orange {
      color: #ffffff;
    }

    /* Word grouping for "the" and "gala" */
    .word {
      display: inline-block;
      white-space: nowrap;
    }

    .word span {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      display: inline-block;
    }

    .word span.outline {
      font-family: 'Nagbuloe Outline', serif;
      font-weight: normal;
    }

    /* Orange section blurb */
    .orange-blurb {
      position: absolute;
      bottom: 5%; /* Mobile: position from bottom to ensure it's always visible below title */
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 1.2rem; /* A bit bigger for better readability */
      color: #000; /* Start as black */
      text-align: center;
      width: 92%; /* Mobile: force container to be wide, close to screen edges */
      line-height: 1.4; /* Mobile: slightly increased for better readability */
      z-index: 5;
      transition: color 0.3s ease;
      padding: 0 1rem; /* Add some padding so text doesn't touch edges */
    }

    @media (max-width: 767px) {
      .orange-blurb {
        top: auto; /* Override top on mobile */
        bottom: 5%; /* Position from bottom on mobile */
      }
    }

    .orange-blurb.on-orange {
      color: #ffffff; /* Changes to white when orange section touches top */
    }

    /* Desktop size for orange blurb */
    @media (min-width: 768px) {
      .orange-blurb {
        top: 73%; /* Desktop: stays at original position */
        font-size: 1.4rem; /* Keep desktop size */
        width: auto; /* Desktop: let it size naturally */
        max-width: 80%; /* Desktop: cap at 80% */
      }
    }

    /* Jukebox container */
    .jukebox-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      width: 2.4rem; /* Mobile: 20% bigger (2rem * 1.2) - about 38px */
      height: 2.4rem; /* Mobile: 20% bigger (2rem * 1.2) - about 38px */
      z-index: 1000;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
    }

    @media (min-width: 768px) {
      .jukebox-container {
        top: 2rem;
        right: 2rem;
        width: 3.6rem; /* Desktop: keep larger size - about 58px */
        height: 3.6rem;
      }
    }

    .jukebox-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: transform 0.3s ease, opacity 0.3s ease;
      transform-origin: center center;
      pointer-events: auto;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      -webkit-backface-visibility: hidden;
      -moz-backface-visibility: hidden;
      backface-visibility: hidden;
      -webkit-transform: translateZ(0);
      -moz-transform: translateZ(0);
      transform: translateZ(0);
      will-change: transform;
    }

    @media (max-width: 767px) {
      .jukebox-image {
        /* Use smooth rendering on mobile to fix pixelation */
        image-rendering: -webkit-optimize-contrast;
        image-rendering: auto;
        image-rendering: smooth;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
    }

    .jukebox-image.twitch {
      animation: jukeboxTwitch 0.5s ease-in-out forwards;
    }

    @keyframes jukeboxTwitch {
      0% { transform: rotate(0deg); opacity: 1; }
      100% { transform: rotate(70deg); opacity: 0; }
    }

    .jukebox-image.activated {
      opacity: 0;
      pointer-events: none;
      display: none;
    }

    /* Jukebox maintains original color on orange background */
    /* Removed color inversion to keep original jukebox colors */

    /* Play button styling - now behind jukebox */
    .play-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 1.8rem; /* Mobile: 20% bigger (1.5rem * 1.2) - about 29px */
      height: 1.8rem; /* Mobile: 20% bigger (1.5rem * 1.2) - about 29px */
      border-radius: 50%;
      background-color: #000;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, background-color 0.3s ease;
      z-index: 1001;
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }

    @media (min-width: 768px) {
      .play-button {
        width: 2.7rem; /* Desktop: keep larger size - about 43px */
        height: 2.7rem;
      }
    }

    .play-button.revealed {
      opacity: 1;
      pointer-events: auto;
      visibility: visible;
      animation: playButtonAppear 0.3s ease-out forwards;
    }

    @keyframes playButtonAppear {
      0% { 
        opacity: 0;
        transform: translate(-50%, -50%) scale(0);
      }
      100% { 
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    .play-button.on-orange {
      background-color: #ffffff;
    }

    .play-button:hover {
      transform: translate(-50%, -50%) scale(1.1);
    }

    .play-button:active {
      transform: translate(-50%, -50%) scale(0.95);
    }

    /* Play triangle */
    .play-button .play-icon {
      width: 0;
      height: 0;
      border-left: 0.538rem solid #ffffff; /* Mobile: 20% bigger (0.448rem * 1.2) */
      border-top: 0.353rem solid transparent; /* Mobile: 20% bigger (0.294rem * 1.2) */
      border-bottom: 0.353rem solid transparent; /* Mobile: 20% bigger (0.294rem * 1.2) */
      margin-left: 0.154rem; /* Mobile: 20% bigger (0.128rem * 1.2) */
    }

    @media (min-width: 768px) {
      .play-button .play-icon {
        border-left: 0.806rem solid #ffffff; /* Desktop: 20% smaller */
        border-top: 0.538rem solid transparent; /* Desktop: 20% smaller */
        border-bottom: 0.538rem solid transparent; /* Desktop: 20% smaller */
        margin-left: 0.23rem; /* Desktop: 20% smaller */
      }
    }

    .play-button.on-orange .play-icon {
      border-left-color: #000000;
    }

    /* Pause icon */
    .play-button .pause-icon {
      display: none;
      width: 0.768rem; /* Mobile: 20% bigger (0.64rem * 1.2) */
      height: 0.922rem; /* Mobile: 20% bigger (0.768rem * 1.2) */
      position: relative;
    }

    .play-button .pause-icon::before,
    .play-button .pause-icon::after {
      content: '';
      position: absolute;
      width: 0.23rem; /* Mobile: 20% bigger (0.192rem * 1.2) */
      height: 0.922rem; /* Mobile: 20% bigger (0.768rem * 1.2) */
      background-color: #ffffff;
    }

    @media (min-width: 768px) {
      .play-button .pause-icon {
        width: 1.152rem; /* Desktop: 20% smaller */
        height: 1.392rem; /* Desktop: 20% smaller */
      }

      .play-button .pause-icon::before,
      .play-button .pause-icon::after {
        width: 0.336rem; /* Desktop: 20% smaller */
        height: 1.392rem; /* Desktop: 20% smaller */
      }
    }

    .play-button.on-orange .pause-icon::before,
    .play-button.on-orange .pause-icon::after {
      background-color: #000000;
    }

    .play-button .pause-icon::before {
      left: 0;
    }

    .play-button .pause-icon::after {
      right: 0;
    }

    .play-button.playing .play-icon {
      display: none;
    }

    .play-button.playing .pause-icon {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Jukebox button -->
  <div class="jukebox-container" id="jukeboxContainer">
    <img src="jukebox.png" alt="Jukebox" class="jukebox-image" id="jukeboxImage">
    <button class="play-button" id="playButton">
      <div class="play-icon"></div>
      <div class="pause-icon"></div>
    </button>
  </div>

  <!-- Hidden YouTube player -->
  <div id="player" style="display: none;"></div>

  <!-- Fixed hero text -->
  <div class="hero">
    <div class="small-text" id="smallText">The fourth annual edition of</div>
    <h1 class="main-title" id="mainTitle">
      <span class="word"><span>t</span><span>h</span><span>e</span></span><span class="space"> </span><span class="word"><span>g</span><span>a</span><span>l</span><span>a</span></span>
    </h1>
  </div>

  <!-- White section - scrolls up to reveal orange -->
  <div class="white-section"></div>

  <!-- Orange section - fixed underneath -->
  <div class="orange-section">
    <div class="orange-blurb">
      From the windows, to the walls: it's time to drop the ball. We're gearing up for a fourth annual New Year's Gala, and would love to have you there
    </div>
  </div>

  <!-- Scroll spacer to allow continued scrolling -->
  <div class="scroll-spacer"></div>

  <!-- Third orange section -->
  <div class="third-section" id="thirdSection">
    <!-- Left column: Details -->
    <div class="third-section-left">
      <h2 class="party-details-header">Details</h2>
      
      <!-- Icons section -->
      <div class="details-icons">
        <div class="detail-item">
          <span class="detail-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="white"/>
            </svg>
          </span>
          <a href="https://www.greenpointloft.com" target="_blank" class="detail-link">The Greenpoint Loft</a>
        </div>
        
        <div class="detail-item">
          <span class="detail-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="5" y="7" width="14" height="10" rx="1" fill="white"/>
              <path d="M9 9h6M9 11h6M9 13h6M9 15h6" stroke="#ff6b35" stroke-width="1" stroke-linecap="round"/>
              <circle cx="5" cy="9.5" r="0.6" fill="#ff6b35"/>
              <circle cx="5" cy="12" r="0.6" fill="#ff6b35"/>
              <circle cx="5" cy="14.5" r="0.6" fill="#ff6b35"/>
              <circle cx="19" cy="9.5" r="0.6" fill="#ff6b35"/>
              <circle cx="19" cy="12" r="0.6" fill="#ff6b35"/>
              <circle cx="19" cy="14.5" r="0.6" fill="#ff6b35"/>
            </svg>
          </span>
          <span class="detail-text">early birds! $125 before Dec. 10th</span>
        </div>
        
        <div class="detail-item">
          <span class="detail-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="6.5" cy="9" r="2" fill="white"/>
              <path d="M2 19c0-2 1.5-3.5 3.5-3.5s3.5 1.5 3.5 3.5" stroke="white" stroke-width="1.8" stroke-linecap="round" fill="none"/>
              <circle cx="17.5" cy="9" r="2" fill="white"/>
              <path d="M13 19c0-2 1.5-3.5 3.5-3.5s3.5 1.5 3.5 3.5" stroke="white" stroke-width="1.8" stroke-linecap="round" fill="none"/>
              <path d="M6.5 11l2.5-1.5M17.5 11l-2.5-1.5" stroke="white" stroke-width="1.2" stroke-linecap="round"/>
              <path d="M5 7l1 2M19 7l-1 2" stroke="white" stroke-width="1" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="detail-text" id="spotsLeft">(<span id="rsvpCount">0</span>/200) spots left</span>
        </div>
      </div>
      
      <!-- Paragraph text -->
      <div class="details-paragraph">
        <p>From the windows, to the walls: it's time to drop the ball. We're gearing up for a third annual New Year's Gala, and would love to have you there.</p>
        <p>What can you expect? The same high quality food and cocktails (open bar all night), two sets of live music from talented friends, a bigger venue (with a roof deck over the east river!), and a chance to meet new people. Yes, it's still black tie.</p>
        <p>As a reminder, nobody makes money on this--everything goes to offset the venue, drinks, small plates, and music. We hope ticket price won't be a barrier for you, but if it is, please reach out at 603-494-0576! We want to see you there.</p>
        <p>Lastly, as always, invite your friends! The whole point of this is to combine crowds, and it's more fun with them there.</p>
        <p>See you NYE.</p>
        <p>If you want to check out the venue, link here: <a href="https://www.instagram.com/greenpoint_loft/" target="_blank" style="color: #ffffff; text-decoration: underline;">https://www.instagram.com/greenpoint_loft/</a></p>
      </div>
    </div>
    
    <!-- Right column: RSVP form -->
    <div class="third-section-right">
      <button class="third-page-rsvp" id="thirdPageRSVP">RSVP</button>
      
      <!-- Guest list - always visible -->
      <div class="guest-list-container" id="guestListContainer">
        <h3 class="guest-list-header">Guests</h3>
        <ul class="guest-list-items" id="guestListRight">
          <!-- Guest names will be added here -->
        </ul>
      </div>
      
      <!-- RSVP form - hidden by default -->
      <div class="rsvp-form-container" id="rsvpFormContainer" style="display: none;">
        <div class="rsvp-content" id="rsvpContent">
          
          <!-- Step 1: Enter Name, Email, and Choose Guest Count -->
          <div class="rsvp-step" id="step1" style="display: block;">
            <input type="text" class="rsvp-input" id="nameInput" placeholder="your name" required>
            
            <input type="email" class="rsvp-input" id="emailInput" placeholder="your email" required style="margin-top: 1rem;">
            
            <!-- Guest count buttons -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; margin-top: 1rem;">
              <button class="rsvp-split-button" id="justMeBtn">just me</button>
              <button class="rsvp-split-button" id="plusOneBtn">plus one</button>
            </div>
            
            <button class="rsvp-button" id="nameBtn">continue</button>
          </div>

          <!-- Step 2: Enter Email (deprecated - keeping for backward compatibility) -->
          <div class="rsvp-step" id="step2" style="display: none;">
            <input type="email" class="rsvp-input" id="emailInput2" placeholder="your email" required>
            <button class="rsvp-button" id="emailBtn">continue</button>
          </div>

          <!-- Step 3: Payment Confirmation -->
          <div class="rsvp-step" id="step3" style="display: none;">
            <p style="color: #ffffff; font-size: 1.1rem; margin-bottom: 1rem; text-align: center; line-height: 1.5;">
              have you paid for your ticket yet?
            </p>
            <p style="color: #ffffff; font-size: 0.9rem; margin-bottom: 1.5rem; text-align: center;">
              if not, send <strong id="ticketPrice">$125</strong> via Venmo:
            </p>
            <a href="https://account.venmo.com/payment-link?amount=125&note=for%20the%20gala!&recipients=maxheald&txn=pay" 
               target="_blank" 
               class="venmo-button" 
               id="venmoPaymentLink"
               style="display: block; text-align: center; margin-bottom: 1rem;">
              venmo max
            </a>
            <button class="rsvp-button" id="paidBtn">i've paid</button>
          </div>

          <!-- Step 4: Guest List View -->
          <div class="rsvp-step" id="step4" style="display: none;">
            <h3 class="guest-list-title">guest list</h3>
            <ul class="guest-list-items" id="guestList">
              <!-- Guest names will be added here -->
            </ul>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Load YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // YouTube Player for "Bad Decisions" by The Strokes
    let player;
    let isPlaying = false;
    let playerReady = false;
    let youtubeActivated = false;

    function onYouTubeIframeAPIReady() {
      // Don't create player immediately - wait for jukebox click
      console.log('YouTube API ready, waiting for jukebox activation...');
    }

    function activateYouTube() {
      if (player && youtubeActivated) {
        return Promise.resolve();
      }

      return new Promise((resolve) => {
        console.log('Activating YouTube player...');
        player = new YT.Player('player', {
          height: '0',
          width: '0',
          videoId: '5fbZTnZDvPA', // "Bad Decisions" by The Strokes (Official Audio)
          playerVars: {
            autoplay: 0,
            controls: 0,
            disablekb: 1,
            fs: 0,
            modestbranding: 1,
            playsinline: 1,
            enablejsapi: 1
          },
          events: {
            'onReady': function(event) {
              playerReady = true;
              youtubeActivated = true;
              console.log('YouTube player ready!');
              
              // Pre-load/cue the video so it's ready to play immediately
              // This ensures the first play button click works
              try {
                player.cueVideoById('5fbZTnZDvPA');
                console.log('Video cued and ready to play');
              } catch (error) {
                console.error('Error cueing video:', error);
              }
              
              // Add play button listener once ready
              const playBtn = document.getElementById('playButton');
              if (playBtn) {
                playBtn.addEventListener('click', togglePlay, { once: false });
              }
              resolve();
            },
            'onStateChange': onPlayerStateChange,
            'onError': onPlayerError
          }
        });
      });
    }

    function onPlayerError(event) {
      console.error('YouTube Player Error:', event.data);
      alert('Unable to play this song. Error code: ' + event.data);
    }

    function onPlayerStateChange(event) {
      // Update button state when video ends
      if (event.data === YT.PlayerState.ENDED) {
        isPlaying = false;
        document.getElementById('playButton').classList.remove('playing');
      }
    }

    function togglePlay() {
      if (!player || !playerReady) {
        console.error('Player not ready yet');
        return;
      }

      if (isPlaying) {
        player.pauseVideo();
        isPlaying = false;
        const playBtn = document.getElementById('playButton');
        if (playBtn) {
          playBtn.classList.remove('playing');
        }
        stopMusicSync(); // Stop text flicker when music pauses
      } else {
        // Check if video is loaded and ready
        const playerState = player.getPlayerState();
        if (playerState === YT.PlayerState.UNSTARTED || playerState === YT.PlayerState.CUED) {
          // Video is ready to play - proceed with play
          console.log('Video ready, starting playback...');
        } else if (playerState === YT.PlayerState.BUFFERING) {
          console.log('Video buffering, waiting...');
          // Wait a bit for buffering
          setTimeout(() => {
            player.playVideo();
          }, 100);
          return;
        }
        
        // Optimistic UI update
        isPlaying = true;
        const playBtn = document.getElementById('playButton');
        if (playBtn) {
          playBtn.classList.add('playing');
        }
        startMusicSync(); // Start text flicker synced to beat
        
        // Mobile-optimized playback: Start muted, then unmute after play succeeds
        player.mute(); // Mute first to satisfy mobile autoplay policies
        
        try {
          player.playVideo();
          
          // Unmute after a short delay to ensure play started
          setTimeout(() => {
            try {
              player.unMute();
              player.setVolume(100);
              console.log('Playing video with audio...');
            } catch (error) {
              console.error('Error unmuting:', error);
            }
          }, 100);
        } catch (error) {
          console.error('Error playing video:', error);
          // Try to unmute anyway
          try {
            player.unMute();
            player.setVolume(100);
          } catch (e) {
            console.error('Error unmuting:', e);
          }
        }
        
        console.log('Play initiated...');
      }
    }

    // Jukebox click handler
    const jukeboxImage = document.getElementById('jukeboxImage');
    const playButton = document.getElementById('playButton');
    
    if (jukeboxImage) {
      jukeboxImage.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (!youtubeActivated) {
          // First click: Activate YouTube and rotate jukebox
          console.log('Jukebox clicked - activating YouTube...');
          jukeboxImage.classList.add('twitch');
          
          try {
            await activateYouTube();
            
            // After rotation animation completes, hide jukebox and reveal play button
            setTimeout(() => {
              jukeboxImage.classList.remove('twitch');
              jukeboxImage.classList.add('activated');
              
              // Reveal play button with poof animation
              if (playButton) {
                playButton.classList.add('revealed');
              }
              console.log('Play button revealed!');
            }, 500); // Match animation duration (0.5s)
          } catch (error) {
            console.error('Error activating YouTube:', error);
            jukeboxImage.classList.remove('twitch');
          }
        }
      });
    }

    // Text flicker animation
    const title = document.getElementById('mainTitle');
    const letters = title.querySelectorAll('.word span');
    let isBold = true;
    let flickerInterval = null;
    let initialAnimationDone = false;
    
    // Initial burst animation on page load
    const burstPattern = [
      50, 50, 50, 150,
      50, 50, 50, 150,
      50, 50, 50, 150,
      50, 50, 50, 150,
      80, 80, 80, 250,
      80, 80, 80, 250,
      80, 80, 250,
      120, 120, 300,
      150, 150, 300,
      200, 300
    ];
    
    let currentIndex = 0;
    
    function flip() {
      isBold = !isBold;
      
      if (isBold) {
        letters.forEach(letter => letter.classList.remove('outline'));
      } else {
        letters.forEach(letter => letter.classList.add('outline'));
      }
    }
    
    function scheduleNextFlip() {
      if (currentIndex >= burstPattern.length) {
        letters.forEach(letter => letter.classList.remove('outline'));
        initialAnimationDone = true;
        isBold = true;
        return;
      }
      
      const delay = burstPattern[currentIndex];
      currentIndex++;
      
      setTimeout(function() {
        flip();
        scheduleNextFlip();
      }, delay);
    }
    
    // Start initial animation on page load
    scheduleNextFlip();
    
    // Beat map for "Bad Decisions" - exact timestamps in seconds
    const beatMap = [
      // Intro (sparse beats)
      0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5,
      // Build-up
      4.0, 4.5, 5.0, 5.5, 6.0, 6.5, 7.0, 7.5,
      // Verse 1 (110 BPM = 0.545s per beat)
      8.0, 8.55, 9.1, 9.65, 10.2, 10.75, 11.3, 11.85,
      12.4, 12.95, 13.5, 14.05, 14.6, 15.15, 15.7, 16.25,
      16.8, 17.35, 17.9, 18.45, 19.0, 19.55, 20.1, 20.65,
      21.2, 21.75, 22.3, 22.85, 23.4, 23.95, 24.5, 25.05,
      // Pre-chorus
      25.6, 26.15, 26.7, 27.25, 27.8, 28.35, 28.9, 29.45,
      30.0, 30.55, 31.1, 31.65, 32.2, 32.75, 33.3, 33.85,
      // Chorus (emphasized beats)
      34.4, 35.5, 36.6, 37.7, 38.8, 39.9, 41.0, 42.1,
      43.2, 44.3, 45.4, 46.5, 47.6, 48.7, 49.8,
      // Verse 2
      50.9, 51.45, 52.0, 52.55, 53.1, 53.65, 54.2, 54.75,
      55.3, 55.85, 56.4, 56.95, 57.5, 58.05, 58.6, 59.15,
      59.7, 60.25, 60.8, 61.35, 61.9, 62.45, 63.0, 63.55,
      64.1, 64.65, 65.2, 65.75, 66.3, 66.85, 67.4, 67.95,
      // Chorus 2
      68.5, 69.6, 70.7, 71.8, 72.9, 74.0, 75.1, 76.2,
      77.3, 78.4, 79.5, 80.6, 81.7, 82.8, 83.9,
      // Bridge/Guitar solo
      85.0, 85.55, 86.1, 86.65, 87.2, 87.75, 88.3, 88.85,
      89.4, 89.95, 90.5, 91.05, 91.6, 92.15, 92.7, 93.25,
      93.8, 94.35, 94.9, 95.45, 96.0, 96.55, 97.1, 97.65,
      98.2, 98.75, 99.3, 99.85, 100.4, 100.95, 101.5, 102.05,
      // Final chorus
      102.6, 103.7, 104.8, 105.9, 107.0, 108.1, 109.2, 110.3,
      111.4, 112.5, 113.6, 114.7, 115.8, 116.9, 118.0,
      // Outro
      119.1, 120.2, 121.3, 122.4, 123.5, 124.6, 125.7, 126.8,
      127.9, 129.0, 130.1, 131.2, 132.3, 133.4, 134.5
    ];
    
    let beatCheckInterval = null;
    let lastBeatIndex = -1;
    
    // Music-synced flicker (triggered when music plays)
    function startMusicSync() {
      if (beatCheckInterval) return; // Already running
      
      // Check playback time 60 times per second
      beatCheckInterval = setInterval(function() {
        if (!player || !player.getCurrentTime) return;
        
        const currentTime = player.getCurrentTime();
        
        // Find the next beat that should trigger
        for (let i = lastBeatIndex + 1; i < beatMap.length; i++) {
          if (currentTime >= beatMap[i] && currentTime < beatMap[i] + 0.1) {
            // We hit a beat!
            flip();
            lastBeatIndex = i;
            break;
          }
        }
        
        // Reset if we've looped or restarted
        if (currentTime < 1.0) {
          lastBeatIndex = -1;
        }
      }, 16); // ~60fps
    }
    
    function stopMusicSync() {
      if (beatCheckInterval) {
        clearInterval(beatCheckInterval);
        beatCheckInterval = null;
        lastBeatIndex = -1;
        // Reset to bold
        isBold = true;
        letters.forEach(letter => letter.classList.remove('outline'));
      }
    }

    // Prevent browser from restoring scroll position
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }

    // Scroll-based color change
    const jukeboxContainer = document.getElementById('jukeboxContainer');
    const smallText = document.getElementById('smallText');
    const mainTitle = document.getElementById('mainTitle');
    const orangeBlurb = document.querySelector('.orange-blurb');

    // Prevent scrolling past the top
    window.addEventListener('scroll', function() {
      if (window.scrollY < 0) {
        window.scrollTo(0, 0);
      }
    });

    // Reset scroll position to top on page load/refresh
    window.addEventListener('beforeunload', function() {
      window.scrollTo(0, 0);
    });

    // Reset scroll position immediately on load
    window.addEventListener('load', function() {
      window.scrollTo(0, 0);
      const whiteSection = document.querySelector('.white-section');
      if (whiteSection) {
        whiteSection.style.transform = 'translateY(0)';
      }
    });

    // Also reset on DOMContentLoaded for faster reset
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        window.scrollTo(0, 0);
        const whiteSection = document.querySelector('.white-section');
        if (whiteSection) {
          whiteSection.style.transform = 'translateY(0)';
        }
      });
    } else {
      window.scrollTo(0, 0);
      const whiteSection = document.querySelector('.white-section');
      if (whiteSection) {
        whiteSection.style.transform = 'translateY(0)';
      }
    }

    window.addEventListener('scroll', function() {
      const scrollY = window.scrollY;
      const viewportHeight = window.innerHeight;
      
      // Prevent scrolling past the top
      if (scrollY < 0) {
        window.scrollTo(0, 0);
        return;
      }
      
      // Move white section up as user scrolls (peeling effect)
      const whiteSection = document.querySelector('.white-section');
      if (whiteSection) {
        if (scrollY === 0) {
          // At the top, ensure white section is fully visible
          whiteSection.style.transform = 'translateY(0)';
        } else {
          // Move white section up by scroll amount, but don't go past -100vh
          const translateY = Math.max(-viewportHeight, -scrollY);
          whiteSection.style.transform = `translateY(${translateY}px)`;
        }
      }
      
      // When scroll passes the viewport height, we're into the orange section
      const playBtn = document.getElementById('playButton');
      if (scrollY >= viewportHeight) {
        if (jukeboxContainer) jukeboxContainer.classList.add('on-orange');
        if (playBtn) playBtn.classList.add('on-orange');
        smallText.classList.add('on-orange');
        mainTitle.classList.add('on-orange');
        orangeBlurb.classList.add('on-orange');
      } else {
        if (jukeboxContainer) jukeboxContainer.classList.remove('on-orange');
        if (playBtn) playBtn.classList.remove('on-orange');
        smallText.classList.remove('on-orange');
        mainTitle.classList.remove('on-orange');
        orangeBlurb.classList.remove('on-orange');
      }

      // Third section slide-up effect - starts after scrolling through orange section (200vh total)
      const thirdSection = document.getElementById('thirdSection');
      const thirdPageRSVP = document.getElementById('thirdPageRSVP');
      
      if (thirdSection) {
        const orangeSectionEnd = viewportHeight * 2; // After white (100vh) + orange (100vh)
        
        // Start sliding up third section after scrolling through orange section
        if (scrollY >= orangeSectionEnd) {
          // Calculate progress from orangeSectionEnd to orangeSectionEnd + viewportHeight
          const thirdSectionStart = orangeSectionEnd;
          const scrollDistance = scrollY - thirdSectionStart;
          const thirdSectionProgress = Math.min(1, scrollDistance / viewportHeight);
          const translateValue = 100 - (thirdSectionProgress * 100); // 100% to 0%
          thirdSection.style.transform = `translateY(${translateValue}%)`;
          thirdSection.style.display = 'flex'; // Ensure it's visible
          
          // Enable scrolling only when section is fully visible (translateY = 0%)
          if (translateValue <= 0) {
            thirdSection.classList.add('scrollable');
          } else {
            thirdSection.classList.remove('scrollable');
          }
          
          // Fade in RSVP button when third section is halfway visible (only once)
          if (thirdPageRSVP && thirdSectionProgress >= 0.5 && !thirdPageRSVP.dataset.fadedIn) {
            setTimeout(() => {
              thirdPageRSVP.classList.add('visible');
            }, 1000); // 1 second delay
            thirdPageRSVP.dataset.fadedIn = 'true'; // Only fade in once
          }
          // Don't remove 'visible' class when scrolling back up - button stays permanently
        } else {
          thirdSection.style.transform = 'translateY(100%)'; // Keep hidden
          thirdSection.classList.remove('scrollable'); // Disable scrolling when hidden
          // Don't remove button visibility - once it appears, it stays
        }
      }
    });
  </script>

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" 
          onerror="console.error('Failed to load Supabase library')"
          onload="console.log('Supabase library loaded successfully')"></script>

  <script>
    // IMMEDIATE TEST - This should log immediately when script runs
    console.log('=== RSVP SCRIPT LOADING ===');
    
    // Test if button exists RIGHT NOW
    setTimeout(() => {
      const testBtn = document.getElementById('thirdPageRSVP');
      console.log('Button check after 100ms:', {
        found: !!testBtn,
        element: testBtn,
        visible: testBtn ? window.getComputedStyle(testBtn).opacity : 'N/A',
        display: testBtn ? window.getComputedStyle(testBtn).display : 'N/A'
      });
      
      // Test listener removed - using main handler instead
    }, 100);
    
    // Initialize Supabase
    let supabase;
    const SUPABASE_URL = 'https://chmllmyqattcdgmuwpgr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNobWxsbXlxYXR0Y2RnbXV3cGdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTk0MzksImV4cCI6MjA3ODI3NTQzOX0.hy1Gf9uN9mj7dxMQxCZVOLk3cEn_UM3BbTeM7WDC0Do';
    
    // Function to initialize Supabase (called after library loads)
    function initSupabase() {
      try {
        // The UMD build exposes supabase on window
        if (window.supabase && window.supabase.createClient) {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log('Supabase initialized successfully');
          console.log('Supabase URL:', SUPABASE_URL);
          
          // Test connection
          testSupabaseConnection();
          return true;
        }
        return false;
      } catch (err) {
        console.error('Error initializing Supabase:', err);
        return false;
      }
    }
    
    // Test Supabase connection
    async function testSupabaseConnection() {
      if (!supabase) return;
      
      try {
        console.log('Testing Supabase connection...');
        // Try a simple query to test connection
        const { data, error } = await supabase
          .from('guests')
          .select('id')
          .limit(1);
        
        if (error) {
          console.error('Supabase connection test failed:', error);
          console.error('Error details:', {
            message: error.message,
            details: error.details,
            hint: error.hint,
            code: error.code
          });
          
          if (error.code === 'PGRST116' || error.message.includes('relation') || error.message.includes('does not exist')) {
            console.error('âš ï¸ TABLE ERROR: The "guests" table does not exist in your Supabase database.');
            console.error('Please create the table in your Supabase dashboard:');
            console.error('1. Go to https://supabase.com/dashboard');
            console.error('2. Select your project');
            console.error('3. Go to Table Editor');
            console.error('4. Create a new table called "guests" with columns:');
            console.error('   - id (uuid, primary key, default: uuid_generate_v4())');
            console.error('   - name (text)');
            console.error('   - email (text)');
            console.error('   - guest_count (integer, default: 1)');
            console.error('   - paid (boolean, default: false)');
            console.error('   - verified (boolean, default: false)');
            console.error('   - created_at (timestamp, default: now())');
          } else if (error.message.includes('Failed to fetch') || error.message.includes('ERR_NAME_NOT_RESOLVED')) {
            console.error('âš ï¸ DNS/Network Error: Cannot reach Supabase. Check:');
            console.error('1. Your internet connection');
            console.error('2. Supabase project URL is correct:', SUPABASE_URL);
            console.error('3. Supabase project is active (not paused)');
            console.error('4. Firewall/VPN is not blocking the connection');
          } else if (error.code === 'PGRST301' || error.message.includes('permission denied')) {
            console.error('âš ï¸ PERMISSION ERROR: Check Row Level Security (RLS) policies in Supabase');
            console.error('The table exists but RLS is blocking access. Disable RLS or add policies.');
          }
        } else {
          console.log('âœ… Supabase connection test successful!');
          console.log('Table "guests" exists and is accessible');
        }
      } catch (err) {
        console.error('Supabase connection test error:', err);
      }
    }
    
    // Wait for DOM and Supabase script to load
    function waitForSupabase() {
      if (initSupabase()) {
        console.log('Supabase ready, will load guests...');
        // Wait longer for all functions to be defined, then load guests
        setTimeout(() => {
          if (typeof loadGuestsFromDatabase === 'function') {
            console.log('Loading guests from database...');
            loadGuestsFromDatabase().catch(err => {
              console.error('Error in loadGuestsFromDatabase:', err);
            });
          } else {
            console.warn('loadGuestsFromDatabase function not found yet, retrying...');
            setTimeout(waitForSupabase, 500);
          }
        }, 500);
      } else {
        // Retry after a short delay
        setTimeout(waitForSupabase, 100);
      }
    }
    
    // Also try loading guests after a longer delay to ensure everything is ready
    window.addEventListener('load', function() {
      setTimeout(() => {
        if (supabase && typeof loadGuestsFromDatabase === 'function') {
          console.log('Window loaded - attempting to load guests again...');
          loadGuestsFromDatabase().catch(err => {
            console.error('Error loading guests on window load:', err);
          });
        }
      }, 1000);
    });
    
    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForSupabase);
    } else {
      waitForSupabase();
    }

    // RSVP form toggle functionality
    const rsvpFormContainer = document.getElementById('rsvpFormContainer');
    const thirdPageRSVPBtn = document.getElementById('thirdPageRSVP');

    // Toggle RSVP form visibility
    if (thirdPageRSVPBtn && rsvpFormContainer) {
      thirdPageRSVPBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const isVisible = rsvpFormContainer.style.display !== 'none';
        
        if (isVisible) {
          // Hide form
          rsvpFormContainer.style.display = 'none';
          thirdPageRSVPBtn.textContent = 'RSVP';
        } else {
          // Show form
          rsvpFormContainer.style.display = 'block';
          // Reset opacity and transition to ensure form is visible
          rsvpFormContainer.style.opacity = '1';
          rsvpFormContainer.style.transition = '';
          thirdPageRSVPBtn.textContent = 'Close';
          
          // Load guests from database
          if (typeof loadGuestsFromDatabase === 'function') {
            try {
              loadGuestsFromDatabase();
            } catch (err) {
              console.error('Error loading guests:', err);
            }
          }
          
          // Always show step 1 (form + guest list)
          if (typeof showStep === 'function') {
            showStep(1);
          } else {
            // Fallback: manually show step 1
            const step1 = document.getElementById('step1');
            if (step1) {
              document.querySelectorAll('.rsvp-step').forEach(step => {
                step.style.display = 'none';
              });
              step1.style.display = 'block';
            }
          }
          
          // Clear inputs for new RSVP
          const nameInput = document.getElementById('nameInput');
          const emailInput = document.getElementById('emailInput');
          if (nameInput) nameInput.value = '';
          if (emailInput) emailInput.value = '';
          
          // Reset guest count selection
          const justMeBtn = document.getElementById('justMeBtn');
          const plusOneBtn = document.getElementById('plusOneBtn');
          if (justMeBtn) justMeBtn.classList.remove('selected');
          if (plusOneBtn) plusOneBtn.classList.remove('selected');
          
          // Reset RSVP data for new submission
          rsvpData.guestCount = null;
          rsvpData.name = '';
          rsvpData.email = '';
          rsvpData.guestId = null;
          rsvpData.isEditingPlusOne = false;
          rsvpData.existingListItem = null;
        }
      });
    }

    // RSVP Multi-Step Flow
    let rsvpData = {
      name: '',
      guestCount: null, // Will be set when user clicks solo or +1
      email: '',
      paid: false,
      isEditingPlusOne: false, // Track if adding +1 to existing entry
      existingListItem: null, // Reference to the list item being edited
      guestId: null // Supabase guest ID
    };

    // Get all step elements
    const steps = {
      step1: document.getElementById('step1'),
      step2: document.getElementById('step2'),
      step3: document.getElementById('step3'),
      step4: document.getElementById('step4')
    };

    // Get all input/button elements
    const nameInput = document.getElementById('nameInput');
    const nameBtn = document.getElementById('nameBtn');
    const justMeBtn = document.getElementById('justMeBtn');
    const plusOneBtn = document.getElementById('plusOneBtn');
    const emailInput = document.getElementById('emailInput');
    const emailBtn = document.getElementById('emailBtn');
    const paidBtn = document.getElementById('paidBtn');
    const guestList = document.getElementById('guestList');
    const guestListRight = document.getElementById('guestListRight');
    const guestListHeader = document.querySelector('#guestListContainer .guest-list-header');
    const ticketPrice = document.getElementById('ticketPrice');

    // Helper function to sync guest lists between step 4 and right-side list
    function syncGuestLists() {
      // Clone nodes instead of copying innerHTML to preserve structure
      guestListRight.innerHTML = '';
      
      Array.from(guestList.children).forEach(child => {
        const cloned = child.cloneNode(true);
        
        // Explicitly copy dataset attributes to ensure they're preserved
        // (cloneNode should do this, but being explicit ensures it works)
        if (child.dataset.guestId) {
          cloned.dataset.guestId = child.dataset.guestId;
        }
        if (child.dataset.guestName) {
          cloned.dataset.guestName = child.dataset.guestName;
        }
        if (child.dataset.guestCount) {
          cloned.dataset.guestCount = child.dataset.guestCount;
        }
        
        // Also ensure buttons inside have their dataset attributes
        const originalButtons = child.querySelectorAll('.edit-option-link');
        const clonedButtons = cloned.querySelectorAll('.edit-option-link');
        originalButtons.forEach((origBtn, index) => {
          if (clonedButtons[index]) {
            if (origBtn.dataset.guestId) {
              clonedButtons[index].dataset.guestId = origBtn.dataset.guestId;
            }
            if (origBtn.dataset.guestName) {
              clonedButtons[index].dataset.guestName = origBtn.dataset.guestName;
            }
            if (origBtn.dataset.guestCount) {
              clonedButtons[index].dataset.guestCount = origBtn.dataset.guestCount;
            }
          }
        });
        
        guestListRight.appendChild(cloned);
        
        // Re-render reactions for cloned item (since cloneNode loses event listeners)
        const guestId = cloned.dataset.guestId;
        if (guestId) {
          renderReactions(cloned, guestId);
        }
      });
      
      // Update guest count display
      updateGuestCount();
    }
    
    // Update guest count display
    function updateGuestCount() {
      if (guestListHeader && guestList) {
        const count = guestList.children.length;
        guestListHeader.textContent = `Guests (${count})`;
      }
      // Also update spots left counter
      updateSpotsLeft();
    }
    
    // Update spots left counter
    function updateSpotsLeft() {
      const rsvpCount = guestList ? guestList.children.length : 0;
      const spotsLeft = 200 - rsvpCount;
      const spotsLeftElement = document.getElementById('rsvpCount');
      if (spotsLeftElement) {
        spotsLeftElement.textContent = spotsLeft;
      }
    }
    
    // Use event delegation for edit buttons - works even after innerHTML copies
    // Store handler reference to prevent duplicate listeners
    let editButtonHandler = null;
    
    function attachEditButtonDelegation() {
      // Remove old handlers if they exist
      if (editButtonHandler) {
        if (guestList) guestList.removeEventListener('click', editButtonHandler);
        if (guestListRight) guestListRight.removeEventListener('click', editButtonHandler);
      }
      
      editButtonHandler = (e) => {
        // Don't interfere with emoji picker clicks
        if (e.target.closest('.emoji-picker') || e.target.closest('.guest-name-clickable') || e.target.closest('.emoji-bubble')) {
          return; // Let emoji handlers deal with it
        }
        
        // Handle edit button clicks
        const editBtn = e.target.closest('.edit-button');
        if (editBtn) {
          e.preventDefault();
          e.stopPropagation();
          const editOptions = editBtn.nextElementSibling;
          if (editOptions && editOptions.classList.contains('edit-options')) {
            editBtn.style.display = 'none';
            editOptions.style.display = 'inline';
          } else {
            // Try finding editOptions as a sibling span
            let sibling = editBtn.nextSibling;
            while (sibling) {
              if (sibling.nodeType === 1 && sibling.querySelector('.edit-option-link')) {
                editBtn.style.display = 'none';
                sibling.style.display = 'inline';
                break;
              }
              sibling = sibling.nextSibling;
            }
          }
          return;
        }
        
        // Handle delete button clicks
        const deleteBtn = e.target.closest('.edit-option-link');
        if (deleteBtn) {
          const btnText = deleteBtn.textContent.trim().toLowerCase();
          if (btnText === 'delete') {
            e.preventDefault();
            e.stopPropagation();
            
            // Find the list item first (most reliable source)
            const listItem = deleteBtn.closest('li');
            
            // Try to get guestId from multiple sources
            let guestId = null;
            let guestName = null;
            
            // Priority 1: List item dataset (most reliable)
            if (listItem) {
              guestId = listItem.dataset.guestId;
              guestName = listItem.dataset.guestName;
            }
            
            // Priority 2: Button dataset
            if (!guestId && deleteBtn.dataset.guestId) {
              guestId = deleteBtn.dataset.guestId;
              guestName = deleteBtn.dataset.guestName || guestName;
            }
            
            // Priority 3: Try to get from the name span's parent
            if (!guestId && listItem) {
              const nameSpan = listItem.querySelector('span:first-child');
              if (nameSpan && nameSpan.dataset.guestId) {
                guestId = nameSpan.dataset.guestId;
                guestName = nameSpan.dataset.guestName || guestName;
              }
            }
            
            console.log('Delete button clicked:', { 
              guestId, 
              guestName, 
              buttonDataset: deleteBtn.dataset,
              listItemDataset: listItem ? listItem.dataset : null,
              listItem: listItem
            });
            
            if (guestId) {
              // Check if this is a temporary ID (not in database)
              if (guestId.toString().startsWith('temp-')) {
                // Just remove from DOM, no database operation needed
                if (confirm(`Remove ${guestName || 'this guest'} from the guest list?`)) {
                  if (listItem) {
                    listItem.remove();
                    syncGuestLists();
                    updateGuestCount();
                  }
                }
                return;
              }
              
              if (confirm(`Remove ${guestName || 'this guest'} from the guest list?`)) {
                (async () => {
                  try {
                    if (!supabase) {
                      throw new Error('Supabase not initialized');
                    }
                    const { error } = await supabase
                      .from('guests')
                      .delete()
                      .eq('id', guestId);
                    if (!error) {
                      // Remove from localStorage tracking
                      removeMyRSVP(guestId);
                      await loadGuestsFromDatabase();
                    } else {
                      console.error('Delete error:', error);
                      alert(`Error deleting guest: ${error.message || 'Please try again.'}`);
                    }
                  } catch (err) {
                    console.error('Delete error:', err);
                    alert(`Error deleting guest: ${err.message || 'Please refresh and try again.'}`);
                  }
                })();
              }
            } else {
              console.error('No guestId found for delete button', {
                deleteBtn,
                listItem,
                buttonDataset: deleteBtn ? deleteBtn.dataset : null,
                listItemDataset: listItem ? listItem.dataset : null
              });
              alert('Error: Could not find guest ID. Please refresh and try again.');
            }
            return;
          }
        }
        
        // Handle +1 button clicks
        const plusOneBtn = e.target.closest('.edit-option-link');
        if (plusOneBtn) {
          const btnText = plusOneBtn.textContent.trim();
          console.log('Edit option link clicked:', btnText, plusOneBtn);
          if (btnText === '+1' || btnText === 'plus one' || btnText.includes('+1')) {
            e.preventDefault();
            e.stopPropagation();
            console.log('+1 button handler triggered');
            
            // Find the list item first (most reliable source)
            const listItem = plusOneBtn.closest('li');
            
            // Try to get data from multiple sources
            let guestId = null;
            let guestName = null;
            let guestCount = 1;
            
            // Priority 1: List item dataset (most reliable)
            if (listItem) {
              guestId = listItem.dataset.guestId;
              guestName = listItem.dataset.guestName;
              guestCount = parseInt(listItem.dataset.guestCount) || 1;
            }
            
            // Priority 2: Button dataset
            if (!guestId && plusOneBtn.dataset.guestId) {
              guestId = plusOneBtn.dataset.guestId;
              guestName = plusOneBtn.dataset.guestName || guestName;
              guestCount = parseInt(plusOneBtn.dataset.guestCount) || guestCount;
            }
            
            // Priority 3: Try to get from the name span's parent
            if (!guestId && listItem) {
              const nameSpan = listItem.querySelector('span:first-child');
              if (nameSpan && nameSpan.dataset.guestId) {
                guestId = nameSpan.dataset.guestId;
                guestName = nameSpan.dataset.guestName || guestName;
                guestCount = parseInt(nameSpan.dataset.guestCount) || guestCount;
              }
            }
            
            console.log('+1 button clicked:', { 
              guestId, 
              guestName, 
              guestCount,
              buttonDataset: plusOneBtn.dataset,
              listItemDataset: listItem ? listItem.dataset : null,
              listItem: listItem
            });
            
            if (guestId) {
              if (guestCount === 2) {
                alert('You already have a +1!');
                return;
              }
              
              if (!supabase) {
                alert('Database connection unavailable. Please refresh the page and try again.');
                return;
              }
              
              // Set up editing state and go through payment flow
              rsvpData.isEditingPlusOne = true;
              rsvpData.name = guestName || '';
              rsvpData.guestId = guestId;
              rsvpData.guestCount = 1; // Will become 2 after payment
              
              // Find the list item to store reference
              const listItem = plusOneBtn.closest('li');
              if (listItem) {
                rsvpData.existingListItem = listItem;
                // Also store data on list item for future reference
                listItem.dataset.guestId = guestId;
                listItem.dataset.guestName = guestName;
              }
              
              ticketPrice.textContent = '$125'; // Additional payment for +1
              const venmoLink = document.getElementById('venmoPaymentLink');
              if (venmoLink) {
                venmoLink.href = 'https://account.venmo.com/payment-link?amount=125&note=for%20the%20gala!&recipients=maxheald&txn=pay';
              }
              
              // Make sure RSVP form container is visible
              const rsvpFormContainer = document.getElementById('rsvpFormContainer');
              if (rsvpFormContainer) {
                rsvpFormContainer.style.display = 'block';
                rsvpFormContainer.style.opacity = '1';
                console.log('RSVP form container shown');
              } else {
                console.error('rsvpFormContainer not found!');
              }
              
              // Update RSVP button text
              const thirdPageRSVPBtn = document.getElementById('thirdPageRSVP');
              if (thirdPageRSVPBtn) {
                thirdPageRSVPBtn.textContent = 'Close';
              }
              
              // Show step 3 (payment screen)
              console.log('Calling showStep(3)...');
              showStep(3); // Go to payment screen
              
              // Double-check step 3 is visible
              setTimeout(() => {
                const step3 = document.getElementById('step3');
                if (step3) {
                  const isVisible = step3.style.display !== 'none';
                  console.log('Step 3 visibility check:', isVisible, step3.style.display);
                  if (!isVisible) {
                    console.error('Step 3 is not visible! Forcing display...');
                    step3.style.display = 'block';
                  }
                } else {
                  console.error('Step 3 element not found!');
                }
              }, 100);
            } else {
              console.error('No guestId found for +1 button');
              alert('Error: Could not find guest ID. Please refresh and try again.');
            }
            return;
          }
        }
      };
      
      // Attach to all guest lists
      if (guestList) guestList.addEventListener('click', editButtonHandler);
      if (guestListRight) guestListRight.addEventListener('click', editButtonHandler);
    }

    // Emoji reactions functionality
    const AVAILABLE_EMOJIS = ['ðŸ‘', 'â¤ï¸', 'ðŸŽ‰', 'ðŸ”¥', 'ðŸ»', 'ðŸ’ƒ'];
    
    // Get user's reactions from localStorage
    function getUserReactions(guestId) {
      const key = `reactions_${guestId}`;
      const stored = localStorage.getItem(key);
      return stored ? JSON.parse(stored) : [];
    }
    
    // Save user's reaction to localStorage (adds to end for order tracking)
    function saveUserReaction(guestId, emoji) {
      const key = `reactions_${guestId}`;
      const reactions = getUserReactions(guestId);
      if (!reactions.includes(emoji)) {
        reactions.push(emoji);
        localStorage.setItem(key, JSON.stringify(reactions));
      }
    }
    
    // Remove user's reaction from localStorage
    function removeUserReaction(guestId, emoji) {
      const key = `reactions_${guestId}`;
      const reactions = getUserReactions(guestId);
      const index = reactions.indexOf(emoji);
      if (index > -1) {
        reactions.splice(index, 1);
        localStorage.setItem(key, JSON.stringify(reactions));
      }
    }
    
    // Check if user has already reacted with this emoji
    function hasUserReacted(guestId, emoji) {
      const reactions = getUserReactions(guestId);
      return reactions.includes(emoji);
    }
    
    // Track RSVPs created on this device
    function getMyRSVPs() {
      const stored = localStorage.getItem('myRSVPs');
      return stored ? JSON.parse(stored) : [];
    }
    
    function addMyRSVP(guestId) {
      const myRSVPs = getMyRSVPs();
      if (!myRSVPs.includes(guestId)) {
        myRSVPs.push(guestId);
        localStorage.setItem('myRSVPs', JSON.stringify(myRSVPs));
      }
    }
    
    function removeMyRSVP(guestId) {
      const myRSVPs = getMyRSVPs();
      const index = myRSVPs.indexOf(guestId);
      if (index > -1) {
        myRSVPs.splice(index, 1);
        localStorage.setItem('myRSVPs', JSON.stringify(myRSVPs));
      }
    }
    
    function isMyRSVP(guestId) {
      const myRSVPs = getMyRSVPs();
      return myRSVPs.includes(guestId);
    }
    
    // Load reactions for a guest from database
    async function loadReactionsForGuest(guestId) {
      if (!supabase) return {};
      
      try {
        const { data, error } = await supabase
          .from('reactions')
          .select('emoji')
          .eq('guest_id', guestId);
        
        if (error) {
          console.error('Error loading reactions:', error);
          return {};
        }
        
        // Count reactions by emoji
        const reactionCounts = {};
        if (data) {
          data.forEach(reaction => {
            reactionCounts[reaction.emoji] = (reactionCounts[reaction.emoji] || 0) + 1;
          });
        }
        
        return reactionCounts;
      } catch (err) {
        console.error('Error loading reactions:', err);
        return {};
      }
    }
    
    // Add or remove reaction to/from database
    async function addReaction(guestId, emoji) {
      if (!supabase) {
        console.error('Supabase not initialized');
        return false;
      }
      
      // Check if user has already reacted - if so, remove it
      if (hasUserReacted(guestId, emoji)) {
        // Remove the reaction
        try {
          const { error } = await supabase
            .from('reactions')
            .delete()
            .eq('guest_id', guestId)
            .eq('emoji', emoji);
          
          if (error) {
            console.error('Error removing reaction:', error);
            return false;
          }
          
          // Remove from localStorage
          removeUserReaction(guestId, emoji);
          return true; // Return true to trigger re-render
        } catch (err) {
          console.error('Error removing reaction:', err);
          return false;
        }
      }
      
      // Add new reaction
      try {
        const { error } = await supabase
          .from('reactions')
          .insert([{
            guest_id: guestId,
            emoji: emoji
          }]);
        
        if (error) {
          console.error('Error adding reaction:', error);
          return false;
        }
        
        // Save to localStorage (adds to end of array for order tracking)
        saveUserReaction(guestId, emoji);
        
        return true;
      } catch (err) {
        console.error('Error adding reaction:', err);
        return false;
      }
    }
    
    // Create emoji bubble element
    function createEmojiBubble(emoji, count, guestId, onClick) {
      const bubble = document.createElement('div');
      bubble.className = 'emoji-bubble';
      bubble.dataset.emoji = emoji;
      bubble.dataset.guestId = guestId;
      
      const emojiSpan = document.createElement('span');
      emojiSpan.className = 'emoji';
      emojiSpan.textContent = emoji;
      bubble.appendChild(emojiSpan);
      
      // Always show count badge (even for count = 1)
      const badge = document.createElement('div');
      badge.className = 'emoji-count-badge';
      badge.textContent = count;
      bubble.appendChild(badge);
      
      if (onClick) {
        bubble.addEventListener('click', (e) => {
          e.stopPropagation();
          onClick(emoji, guestId);
        });
      }
      
      return bubble;
    }
    
    // Create emoji picker element
    function createEmojiPicker(guestId, onEmojiSelect) {
      const picker = document.createElement('div');
      picker.className = 'emoji-picker';
      picker.dataset.guestId = guestId;
      
      AVAILABLE_EMOJIS.forEach(emoji => {
        const emojiBtn = document.createElement('div');
        emojiBtn.className = 'emoji-picker-emoji';
        emojiBtn.dataset.emoji = emoji;
        
        // Add 'clicked' class if user has reacted with this emoji (only in picker)
        if (hasUserReacted(guestId, emoji)) {
          emojiBtn.classList.add('clicked');
        }
        
        const emojiSpan = document.createElement('span');
        emojiSpan.className = 'emoji';
        emojiSpan.textContent = emoji;
        emojiBtn.appendChild(emojiSpan);
        
        emojiBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          // Prevent clicking already clicked emojis
          if (emojiBtn.classList.contains('clicked')) {
            return; // Already clicked, don't do anything
          }
          onEmojiSelect(emoji, guestId);
          picker.classList.remove('active');
        });
        
        picker.appendChild(emojiBtn);
      });
      
      return picker;
    }
    
    // Render reactions for a guest list item
    async function renderReactions(listItem, guestId) {
      console.log('renderReactions called for guestId:', guestId, 'listItem:', listItem);
      
      // Remove existing reactions container if any
      const existingReactions = listItem.querySelector('.guest-reactions');
      if (existingReactions) {
        existingReactions.remove();
      }
      
      // Remove existing picker if any
      const existingPicker = listItem.querySelector('.emoji-picker');
      if (existingPicker) {
        existingPicker.remove();
      }
      
      // Load reactions from database
      const reactionCounts = await loadReactionsForGuest(guestId);
      console.log('Reaction counts loaded:', reactionCounts);
      
      // Sort reactions by count (highest first), then by emoji order for ties
      const sortedReactions = Object.entries(reactionCounts).sort(([emojiA, countA], [emojiB, countB]) => {
        // First sort by count (descending - highest first)
        if (countB !== countA) {
          return countB - countA;
        }
        // If counts are equal, maintain consistent order (by emoji character)
        return emojiA.localeCompare(emojiB);
      });
      
      // Create reactions container
      const reactionsContainer = document.createElement('div');
      reactionsContainer.className = 'guest-reactions';
      
      // Add existing reaction bubbles in sorted order (highest count first, leftmost)
      sortedReactions.forEach(([emoji, count]) => {
        const bubble = createEmojiBubble(emoji, count, guestId, async (selectedEmoji, gId) => {
          const success = await addReaction(gId, selectedEmoji);
          if (success) {
            // Reload reactions
            await renderReactions(listItem, gId);
            // Also update in other list if it exists
            const otherList = guestList === listItem.parentElement ? guestListRight : guestList;
            if (otherList) {
              const otherItem = Array.from(otherList.children).find(li => 
                li.dataset.guestId === gId
              );
              if (otherItem) {
                await renderReactions(otherItem, gId);
              }
            }
          }
        });
        reactionsContainer.appendChild(bubble);
      });
      
      // Create emoji picker
      const picker = createEmojiPicker(guestId, async (selectedEmoji, gId) => {
        const success = await addReaction(gId, selectedEmoji);
        if (success) {
          // Reload reactions
          await renderReactions(listItem, gId);
          // Also update in other list if it exists
          const otherList = guestList === listItem.parentElement ? guestListRight : guestList;
          if (otherList) {
            const otherItem = Array.from(otherList.children).find(li => 
              li.dataset.guestId === gId
            );
            if (otherItem) {
              await renderReactions(otherItem, gId);
            }
          }
        }
      });
      
      // Find the name span - it's the first span that contains the guest name
      const nameSpan = listItem.querySelector('span:first-child');
      console.log('Looking for name span in listItem:', listItem, 'Found:', nameSpan);
      
      if (!nameSpan) {
        console.error('Name span not found in listItem. Children:', Array.from(listItem.children).map(c => c.tagName + (c.className ? '.' + c.className : '')));
        return;
      }
      
      console.log('Name span found:', nameSpan, 'Text:', nameSpan.textContent);
      
      // Insert picker into DOM first
      listItem.appendChild(picker);
      console.log('Picker inserted into DOM');
      
      // Insert reactions container immediately after name span (right next to name)
      // Use insertBefore with nextSibling - if nextSibling is null, it will append to end
      if (nameSpan.nextSibling) {
        listItem.insertBefore(reactionsContainer, nameSpan.nextSibling);
      } else {
        // If no next sibling, nameSpan is last, so append to parent (which puts it right after)
        listItem.appendChild(reactionsContainer);
      }
      
      // Make name clickable to show picker (using event delegation instead of direct handler)
      nameSpan.classList.add('guest-name-clickable');
      nameSpan.dataset.guestId = guestId; // Store guestId for event delegation
      console.log('Name span prepared for clicking. GuestId:', guestId, 'Span:', nameSpan);
      
    }
    
    // Global click handler for emoji picker (using event delegation)
    if (!window.emojiPickerClickHandlerAdded) {
      // Handle clicks on guest names to show picker
      document.addEventListener('click', function(e) {
        // Check if clicking on a guest name
        const nameSpan = e.target.closest('.guest-name-clickable');
        if (nameSpan) {
          e.stopPropagation();
          e.preventDefault();
          const guestId = nameSpan.dataset.guestId;
          const listItem = nameSpan.closest('li');
          
          console.log('=== NAME CLICKED (delegation)! === Guest:', guestId, 'ListItem:', listItem);
          
          if (listItem) {
            const existingPicker = listItem.querySelector('.emoji-picker');
            console.log('Picker found:', !!existingPicker);
            
            if (existingPicker) {
              // Close all other pickers first
              document.querySelectorAll('.emoji-picker.active').forEach(p => {
                if (p !== existingPicker) {
                  p.classList.remove('active');
                }
              });
              const wasActive = existingPicker.classList.contains('active');
              
              if (!wasActive) {
                // Position picker below the name span, aligned with name row
                const nameRect = nameSpan.getBoundingClientRect();
                existingPicker.style.top = (nameRect.bottom + 8) + 'px'; // 8px margin below
                existingPicker.style.left = nameRect.left + 'px'; // Align with name left edge
              }
              
              existingPicker.classList.toggle('active');
              console.log('Picker toggled. Was active:', wasActive, 'Now active:', existingPicker.classList.contains('active'));
              console.log('Picker computed display:', window.getComputedStyle(existingPicker).display);
            } else {
              console.error('Picker not found in listItem!', listItem);
            }
          }
          return;
        }
        
        // Close all pickers if clicking outside picker or name
        if (!e.target.closest('.emoji-picker') && !e.target.closest('.guest-name-clickable')) {
          document.querySelectorAll('.emoji-picker.active').forEach(picker => {
            picker.classList.remove('active');
          });
        }
      }, true); // Use capture phase
      window.emojiPickerClickHandlerAdded = true;
      console.log('Global emoji picker click handler attached');
    }

    // Load existing guests from Supabase
    async function loadGuestsFromDatabase() {
      try {
        if (!supabase) {
          console.warn('Supabase not initialized yet, skipping guest load');
          return;
        }
        
        console.log('Loading guests from Supabase...');
        
        // Try loading with paid field first, fallback to verified if needed
        let { data, error } = await supabase
          .from('guests')
          .select('*')
          .eq('paid', true)
          .order('created_at', { ascending: true });
        
        console.log('First query - paid=true:', { dataCount: data?.length, error });
        
        // If error or no data, try with verified field (backward compatibility)
        if (error || !data || data.length === 0) {
          console.log('Trying with verified field...');
          const { data: data2, error: error2 } = await supabase
            .from('guests')
            .select('*')
            .eq('verified', true)
            .order('created_at', { ascending: true });
          
          console.log('Second query - verified=true:', { dataCount: data2?.length, error2 });
          
          if (!error2 && data2) {
            data = data2;
            error = null;
          }
        }
        
        if (error) {
          console.error('Error loading guests:', error);
          // Don't return - still update count to show 0
          data = [];
        }
        
        if (!data) {
          data = [];
        }
        
        console.log(`Successfully loaded ${data.length} guests from database`);
        
        // Clear existing list
        guestList.innerHTML = '';
        
        // Add each guest to the list
        data.forEach(guest => {
          const li = document.createElement('li');
          // Store guest data on list item for event delegation
          li.dataset.guestId = guest.id;
          li.dataset.guestName = guest.name;
          li.dataset.guestCount = guest.guest_count || 1;
          
          const guestText = guest.guest_count === 2 ? 
            `${guest.name} +1` : 
            guest.name;
          
          const nameSpan = document.createElement('span');
          nameSpan.textContent = guestText;
          
          // Create edit button only if this RSVP was created on this device
          let editBtn = null;
          if (isMyRSVP(guest.id)) {
            editBtn = document.createElement('button');
            editBtn.textContent = 'edit';
            editBtn.classList.add('edit-button');
            editBtn.classList.add('visible');
            editBtn.style.marginLeft = '0.5rem';
          }
          
          li.appendChild(nameSpan);
          
          // Only add edit button and options if this is the user's RSVP
          if (editBtn) {
            // Create options container
            const editOptions = document.createElement('span');
            editOptions.style.display = 'none';
            editOptions.style.marginLeft = '0.5rem';
            
            // +1 button
            const plusOneBtn = document.createElement('button');
            plusOneBtn.textContent = '+1';
            plusOneBtn.classList.add('edit-option-link');
            plusOneBtn.dataset.guestId = guest.id;
            plusOneBtn.dataset.guestName = guest.name;
            plusOneBtn.dataset.guestCount = guest.guest_count;
            plusOneBtn.dataset.listItem = 'true'; // Mark that this is from database list
            // Event listener will be handled by delegation
            
            // Separator
            const separator = document.createElement('span');
            separator.textContent = ' | ';
            separator.style.color = '#fff';
            separator.style.opacity = '0.6';
            
            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'delete';
            deleteBtn.classList.add('edit-option-link');
            deleteBtn.dataset.guestId = guest.id;
            deleteBtn.dataset.guestName = guest.name;
            // Event listener will be handled by delegation
            
            editOptions.appendChild(deleteBtn);
            editOptions.appendChild(separator);
            editOptions.appendChild(plusOneBtn);
            
            // Add class to editOptions for easier delegation
            editOptions.classList.add('edit-options');
            
            // Edit button click handler (event delegation will also handle this)
            editBtn.addEventListener('click', function(e) {
              e.stopPropagation();
              editBtn.style.display = 'none';
              editOptions.style.display = 'inline';
            });
            
            li.appendChild(editBtn);
            li.appendChild(editOptions);
          }
          guestList.appendChild(li);
          
          // Render reactions for this guest
          renderReactions(li, guest.id);
        });
        
        syncGuestLists();
        attachEditButtonDelegation(); // Ensure delegation is set up
        updateGuestCount(); // Update count display
      } catch (err) {
        console.error('Error loading guests:', err);
        // Still update count even if there's an error (will show 0)
        updateGuestCount();
      }
    }

    // Helper function to show specific step
    function showStep(stepNum) {
      Object.values(steps).forEach(step => step.style.display = 'none');
      steps[`step${stepNum}`].style.display = 'block';
    }

    // Step 1: Name input and guest count selection (combined)
    const venmoPaymentLink = document.getElementById('venmoPaymentLink');
    
    // Guest count buttons (on step 1)
    justMeBtn.addEventListener('click', () => {
      rsvpData.guestCount = 1;
      ticketPrice.textContent = '$125';
      if (venmoPaymentLink) {
        venmoPaymentLink.href = 'https://account.venmo.com/payment-link?amount=125&note=for%20the%20gala!&recipients=maxheald&txn=pay';
      }
      // Update button styles
      justMeBtn.classList.add('selected');
      plusOneBtn.classList.remove('selected');
    });

    plusOneBtn.addEventListener('click', () => {
      rsvpData.guestCount = 2;
      ticketPrice.textContent = '$250';
      if (venmoPaymentLink) {
        venmoPaymentLink.href = 'https://account.venmo.com/payment-link?amount=250&note=for%20the%20gala!&recipients=maxheald&txn=pay';
      }
      // Update button styles
      plusOneBtn.classList.add('selected');
      justMeBtn.classList.remove('selected');
    });

    // Continue button on step 1 - goes directly to payment
    nameBtn.addEventListener('click', () => {
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      
      if (!name) {
        alert('Please enter your name');
        return;
      }
      
      if (!email || !email.includes('@')) {
        alert('Please enter a valid email address');
        return;
      }
      
      if (!rsvpData.guestCount) {
        alert('Please select just me or plus one');
        return;
      }
      
      // Save both name and email
      rsvpData.name = name;
      rsvpData.email = email;
      
      // Go directly to payment screen
      showStep(3);
    });

    // Step 2: Email input (deprecated - keeping for backward compatibility)
    emailBtn.addEventListener('click', () => {
      const email = emailInput.value.trim() || (document.getElementById('emailInput2') ? document.getElementById('emailInput2').value.trim() : '');
      if (email && email.includes('@')) {
        rsvpData.email = email;
        showStep(3); // Go to payment screen
      } else {
        alert('Please enter a valid email address');
      }
    });

    // Step 3: Payment confirmation
    paidBtn.addEventListener('click', async () => {
      try {
        // Check if Supabase is available
        if (!supabase) {
          console.error('Supabase not initialized');
          // Still proceed with UI updates even if database fails
          alert('Database connection unavailable. Your RSVP will be saved locally but may not appear in the guest list.');
        }
        
        if (rsvpData.isEditingPlusOne && rsvpData.existingListItem) {
          // Updating existing entry to add +1
          let updateSuccess = false;
          if (supabase) {
            try {
              // Try with paid field first, fallback to verified if needed
              let { error } = await supabase
                .from('guests')
                .update({ guest_count: 2, paid: true })
                .eq('id', rsvpData.guestId);
              
              // If error, try with verified field (backward compatibility)
              if (error) {
                console.error('Supabase error (trying paid):', error);
                const { error: error2 } = await supabase
                  .from('guests')
                  .update({ guest_count: 2, verified: true })
                  .eq('id', rsvpData.guestId);
                
                if (error2) {
                  console.error('Supabase error (trying verified):', error2);
                  alert(`Error updating guest: ${error2.message || 'Please try again.'}`);
                } else {
                  updateSuccess = true;
                }
              } else {
                updateSuccess = true;
              }
            } catch (err) {
              console.error('Error updating +1:', err);
              alert(`Error updating guest: ${err.message || 'Please try again.'}`);
            }
          }
          
          if (updateSuccess) {
            // Reload guests from database to ensure consistency
            await loadGuestsFromDatabase();
          } else {
            // If database update failed, still update UI but show warning
            const nameSpan = rsvpData.existingListItem.querySelector('span');
            if (nameSpan) {
              nameSpan.textContent = `${rsvpData.name} +1`;
              nameSpan.classList.add('guest-name-animated');
            }
            rsvpData.existingListItem.dataset.guestCount = 2;
            syncGuestLists();
          }
          
          // Reset editing state
          rsvpData.isEditingPlusOne = false;
          rsvpData.existingListItem = null;
          rsvpData.guestId = null;
          
          // Hide form container (fade away form elements)
          const rsvpFormContainer = document.getElementById('rsvpFormContainer');
          if (rsvpFormContainer) {
            rsvpFormContainer.style.transition = 'opacity 0.5s ease';
            rsvpFormContainer.style.opacity = '0';
            setTimeout(() => {
              rsvpFormContainer.style.display = 'none';
            }, 500);
          }
          
          // Change button back to RSVP
          const thirdPageRSVPBtn = document.getElementById('thirdPageRSVP');
          if (thirdPageRSVPBtn) {
            thirdPageRSVPBtn.textContent = 'RSVP';
          }
          
          // Clear inputs
          nameInput.value = '';
          emailInput.value = '';
          
          // Reset guest count selection
          justMeBtn.classList.remove('selected');
          plusOneBtn.classList.remove('selected');
          rsvpData.guestCount = null;
          rsvpData.name = '';
          rsvpData.email = '';
        } else {
          // New RSVP: Save to Supabase
          let data = null;
          let error = null;
          
          if (supabase) {
            // Try with email and paid fields first, fallback to phone/verified if needed
            let insertData = {
              name: rsvpData.name,
              guest_count: rsvpData.guestCount
            };
            
            // Try email field first
            let result = await supabase
              .from('guests')
              .insert([{
                ...insertData,
                email: rsvpData.email,
                paid: true
              }])
              .select();
            
            data = result.data;
            error = result.error;
            
            // If error, try with phone field (for backward compatibility)
            if (error) {
              console.error('Supabase error (trying email/paid):', error);
              const result2 = await supabase
                .from('guests')
                .insert([{
                  ...insertData,
                  phone: rsvpData.email, // Store email in phone field as fallback
                  verified: true
                }])
                .select();
              
              if (result2.error) {
                console.error('Supabase error (trying phone/verified):', result2.error);
                // Continue with UI update even if database fails
              } else {
                data = result2.data;
                error = null;
              }
            }
          }
          
          // Store guest ID if we got data
          if (data && data[0]) {
            rsvpData.guestId = data[0].id;
            // Mark this RSVP as created on this device
            addMyRSVP(data[0].id);
          }
          
          // Add new guest to list with animation
          const li = document.createElement('li');
          const guestText = rsvpData.guestCount === 2 ? 
            `${rsvpData.name} +1` : 
            rsvpData.name;
          
          // Create name span
          const nameSpan = document.createElement('span');
          nameSpan.textContent = guestText;
          nameSpan.classList.add('guest-name-animated');
          
          // Create edit button
          const editBtn = document.createElement('button');
          editBtn.textContent = 'edit';
          editBtn.classList.add('edit-button');
          editBtn.style.opacity = '0';
          editBtn.style.transition = 'opacity 0.5s ease';
          editBtn.style.marginLeft = '0.5rem';
          
          // Create options container
          const editOptions = document.createElement('span');
          editOptions.style.display = 'none';
          editOptions.style.marginLeft = '0.5rem';
          
          // Delete button
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'delete';
          deleteBtn.classList.add('edit-option-link');
          if (data && data[0]) {
            deleteBtn.dataset.guestId = data[0].id;
            deleteBtn.dataset.guestName = rsvpData.name;
          }
          // Event listener handled by delegation
          
          // Separator
          const separator = document.createElement('span');
          separator.textContent = ' | ';
          separator.style.color = '#fff';
          separator.style.opacity = '0.6';
          
          // +1 button
          const plusOneBtn = document.createElement('button');
          plusOneBtn.textContent = '+1';
          plusOneBtn.classList.add('edit-option-link');
          if (data && data[0]) {
            plusOneBtn.dataset.guestId = data[0].id;
            plusOneBtn.dataset.guestName = rsvpData.name;
            plusOneBtn.dataset.guestCount = rsvpData.guestCount;
          }
          // Event listener handled by delegation
          
          editOptions.appendChild(deleteBtn);
          editOptions.appendChild(separator);
          editOptions.appendChild(plusOneBtn);
          
          // Add class to editOptions for easier delegation
          editOptions.classList.add('edit-options');
          
          // Edit button click handler (event delegation will also handle this)
          editBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            editBtn.style.display = 'none';
            editOptions.style.display = 'inline';
          });
          
          // Store guest data on list item FIRST (before appending children)
          // This ensures dataset is always available for event delegation
          if (data && data[0]) {
            li.dataset.guestId = data[0].id;
            li.dataset.guestName = rsvpData.name;
            li.dataset.guestCount = rsvpData.guestCount;
          } else {
            // Even if database insert failed, set a temporary ID so buttons work
            // This prevents the "Could not find guest ID" error
            li.dataset.guestId = 'temp-' + Date.now();
            li.dataset.guestName = rsvpData.name;
            li.dataset.guestCount = rsvpData.guestCount;
            console.warn('Guest added without database ID - using temporary ID');
          }
          
          li.appendChild(nameSpan);
          li.appendChild(editBtn);
          li.appendChild(editOptions);
          guestList.appendChild(li); // Add to bottom of list
          
          // Render reactions for new guest
          if (data && data[0] && data[0].id) {
            renderReactions(li, data[0].id);
          } else if (rsvpData.guestId) {
            renderReactions(li, rsvpData.guestId);
          }
          
          // Sync guest list to step 1 and right side
          syncGuestLists();
          attachEditButtonDelegation(); // Ensure delegation is set up
          
          // Fade in edit button after 2 second animation
          setTimeout(() => {
            editBtn.style.opacity = '1';
            syncGuestLists();
          }, 2000);
          
          // Hide form container (fade away form elements)
          const rsvpFormContainer = document.getElementById('rsvpFormContainer');
          if (rsvpFormContainer) {
            rsvpFormContainer.style.transition = 'opacity 0.5s ease';
            rsvpFormContainer.style.opacity = '0';
            setTimeout(() => {
              rsvpFormContainer.style.display = 'none';
              // Reset opacity and transition for next time form is opened
              rsvpFormContainer.style.opacity = '1';
              rsvpFormContainer.style.transition = '';
            }, 500);
          }
          
          // Change button back to RSVP
          const thirdPageRSVPBtn = document.getElementById('thirdPageRSVP');
          if (thirdPageRSVPBtn) {
            thirdPageRSVPBtn.textContent = 'RSVP';
          }
          
          // Clear inputs for next RSVP
          nameInput.value = '';
          emailInput.value = '';
          
          // Reset guest count selection
          justMeBtn.classList.remove('selected');
          plusOneBtn.classList.remove('selected');
          rsvpData.guestCount = null;
          rsvpData.name = '';
          rsvpData.email = '';
          rsvpData.guestId = null;
          rsvpData.isEditingPlusOne = false;
          rsvpData.existingListItem = null;
        }
      } catch (err) {
        console.error('Error:', err);
        alert('Error processing payment. Please try again.');
      }
    });


    // Reset RSVP flow when modal is opened (if navRSVP exists)
    const navRSVP = document.getElementById('navRSVP');
    if (navRSVP) {
      navRSVP.addEventListener('click', async () => {
        // Load guests from database
        await loadGuestsFromDatabase();
        
        // Always show step 1 (form + guest list)
        showStep(1);
        // Clear inputs for new RSVP
        nameInput.value = '';
        emailInput.value = '';
      });
    }


    // Attach event delegation for edit buttons (works even after modal reopens)
    attachEditButtonDelegation();
    
    // Note: Guests are loaded by waitForSupabase() after Supabase initializes
    // Don't call loadGuestsFromDatabase() here as it may run before Supabase is ready
    
    // Debug: Verify RSVP button setup
    console.log('RSVP Setup Check:', {
      buttonExists: !!document.getElementById('thirdPageRSVP'),
      formContainerExists: !!document.getElementById('rsvpFormContainer'),
      buttonElement: document.getElementById('thirdPageRSVP'),
      buttonVisible: document.getElementById('thirdPageRSVP')?.classList.contains('visible'),
      buttonOpacity: window.getComputedStyle(document.getElementById('thirdPageRSVP') || document.body).opacity
    });
  </script>


</body>
</html>

