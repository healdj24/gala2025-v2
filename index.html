<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Gala 2025</title>
  <style>
    @font-face {
      font-family: 'Nagbuloe';
      src: url('./fonts/NEWnagbuloe-bold.otf') format('opentype');
      font-weight: bold;
      font-style: normal;
    }

    @font-face {
      font-family: 'Nagbuloe Outline';
      src: url('./fonts/NEWNagbuloe-ThinOutline.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow-x: hidden;
    }

    /* White section at top - scrolls up like peeling layer */
    .white-section {
      position: relative;
      height: 100vh;
      background: #ffffff;
      z-index: 20;
    }

    /* Orange section below - fixed underneath */
    .orange-section {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      min-height: 100vh;
      background: #ff6b35;
      z-index: 1;
    }

    /* Spacer to allow scrolling */
    .scroll-spacer {
      position: relative;
      height: 200vh; /* Extended to allow third page - 100vh for orange section + 100vh for third section */
      z-index: 0;
    }

    /* Third orange section that slides up */
    .third-section {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100vh;
      background: #ff6b35;
      z-index: 150; /* Higher than hero container (100) to cover it */
      transform: translateY(100%); /* Start hidden below */
      /* No transition - will be controlled directly by scroll */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      gap: 2rem;
    }

    .third-section-content {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 0.94rem; /* Same as orange-blurb on mobile */
      color: #ffffff;
      text-align: center;
      width: 92%; /* Same width as orange-blurb on mobile */
      max-width: 90%;
      line-height: 1.4;
      padding: 0 1rem;
    }

    @media (min-width: 768px) {
      .third-section-content {
        font-size: 1.6rem; /* Slightly bigger than orange-blurb (1.4rem) for desktop since it's a full screen */
        width: auto;
        max-width: 70%; /* Centered and not too wide */
      }
    }

    /* RSVP button on third page */
    .third-page-rsvp {
      padding: 0.4rem 0.9rem;
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 0.9rem;
      color: #ffffff;
      background: #ff6b35;
      border: 2px solid #ffffff; /* White border on orange background */
      border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
      cursor: pointer;
      user-select: none;
      text-transform: uppercase;
      opacity: 0; /* Start invisible */
    }

    .third-page-rsvp.visible {
      opacity: 1;
    }

    .third-page-rsvp.flicker-thin {
      font-family: 'Nagbuloe Outline', serif;
      font-weight: normal;
      border: none; /* Remove border during thin flicker */
    }

    .third-page-rsvp:hover {
      opacity: 0.8;
    }

    @media (min-width: 768px) {
      .third-page-rsvp {
        padding: 0.7rem 1.5rem;
        font-size: 1.8rem;
      }
    }

    .nav-item:hover {
      opacity: 0.8;
    }

    .nav-item:active {
      opacity: 0.6;
    }

    /* Modal/Popup Styles */
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ff6b35;
      border: 5px solid #ffffff;
      z-index: 2000;
      display: none; /* Hidden by default */
      padding: 2rem;
      cursor: move; /* Shows that it's draggable */
      touch-action: none; /* Prevents default touch scrolling during drag */
    }

    .modal.active {
      display: block;
    }

    /* Details modal sizing */
    .modal.details-modal {
      width: 80%;
      max-height: 70vh;
      overflow-y: auto;
    }

    @media (min-width: 768px) {
      .modal.details-modal {
        width: 30%;
      }
    }

    /* RSVP modal sizing */
    .modal.rsvp-modal {
      width: 79.2%; /* 10% wider than 72% on mobile */
      max-height: 70vh;
      overflow-y: auto;
    }

    @media (min-width: 768px) {
      .modal.rsvp-modal {
        width: 33%; /* 10% wider than 30% on desktop */
      }
    }

    /* Modal header with close button */
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #ffffff;
    }

    .modal-title {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 2rem;
      color: #ffffff;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      color: #ffffff;
      font-size: 2.5rem;
      line-height: 1;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease;
      font-family: Arial, sans-serif;
      font-weight: 300;
    }

    .modal-close:hover {
      opacity: 0.7;
    }

    /* Modal content */
    .modal-content {
      font-family: 'Nagbuloe', serif;
      font-size: 1rem;
      color: #ffffff;
      line-height: 1.6;
      max-height: calc(70vh - 120px); /* Subtract header height */
      overflow-y: auto; /* Enable scrolling */
      padding-right: 0.5rem; /* Space for scrollbar */
    }

    /* Custom white scrollbar for modal content */
    .modal-content::-webkit-scrollbar {
      width: 8px;
    }

    .modal-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }

    .modal-content::-webkit-scrollbar-thumb {
      background: #ffffff;
      border-radius: 4px;
    }

    .modal-content::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .modal-content p {
      margin-bottom: 1rem;
    }

    /* RSVP form styles */
    .rsvp-form {
      margin-bottom: 2rem;
    }

    .rsvp-input {
      width: 100%;
      padding: 0.68rem 1rem; /* 10% skinnier vertically (0.75 * 0.9) */
      font-family: 'Nagbuloe', serif;
      font-size: 1rem;
      border: 2px solid #ffffff;
      border-radius: 25px;
      background: #ffffff;
      color: #000000;
      margin-bottom: 1rem;
    }

    .rsvp-button {
      width: 100%;
      padding: 0.68rem 1rem; /* 10% skinnier vertically (0.75 * 0.9) */
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 1rem;
      border: 2px solid #ffffff;
      border-radius: 25px;
      background: #ffffff;
      color: #ff6b35;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .rsvp-button:hover {
      opacity: 0.8;
    }

    /* Split buttons for "just me" / "plus one" */
    .rsvp-split-button {
      flex: 1;
      padding: 0.68rem 1rem;
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 1rem;
      border: 2px solid #ffffff;
      border-radius: 25px;
      background: #ff6b35;
      color: #ffffff;
      cursor: pointer;
      transition: opacity 0.2s ease;
      text-transform: lowercase;
    }

    .rsvp-split-button:hover {
      opacity: 0.8;
    }

    /* Animated guest name in list */
    @keyframes nameFlicker {
      0%, 10%, 20%, 30%, 40%, 50%, 60%, 70%, 80%, 90%, 100% {
        font-family: 'Nagbuloe', serif;
        font-weight: bold;
      }
      5%, 15%, 25%, 35%, 45%, 55%, 65%, 75%, 85%, 95% {
        font-family: 'Nagbuloe Outline', serif;
        font-weight: normal;
      }
    }

    .guest-name-animated {
      animation: nameFlicker 2s ease-in-out;
    }

    .guest-list {
      margin-top: 1.5rem;
    }

    .guest-list-title {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 1.2rem;
      color: #ffffff;
      margin-bottom: 0.5rem;
      text-align: center; /* Center to match the buttons */
    }

    .guest-list-items {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .guest-list-items li {
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Edit button styling */
    .edit-button {
      font-family: 'Nagbuloe', serif;
      font-size: 0.8rem;
      color: #ffffff;
      background: none;
      border: none;
      cursor: pointer;
      text-decoration: underline;
      opacity: 0;
      transition: opacity 0.5s ease;
      padding: 0;
      text-transform: lowercase;
      pointer-events: auto; /* Ensure clickable */
    }

    .edit-button.visible {
      opacity: 1;
    }

    .edit-button:hover {
      opacity: 0.7;
    }

    /* Ensure edit container is clickable */
    .guest-list-items li > div {
      pointer-events: auto;
    }

    /* Edit options as plain text */
    .edit-options {
      display: none;
      align-items: center;
      gap: 0.3rem;
    }

    .edit-options.active {
      display: flex;
    }

    .edit-option-link {
      font-family: 'Nagbuloe', serif;
      font-size: 0.7rem;
      color: #ffffff;
      background: none;
      border: none;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      text-transform: lowercase;
    }

    .edit-option-link:hover {
      opacity: 0.7;
    }

    .edit-separator {
      color: #ffffff;
      font-size: 0.7rem;
      opacity: 0.6;
    }

    .guest-list-items li {
      position: relative;
    }

    /* Fixed hero content */
    .hero {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 100;
      pointer-events: none;
    }

    .small-text {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      font-size: 0.75rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #000;
      margin-bottom: 1rem;
      font-weight: 400;
      transition: color 0.3s ease;
    }

    .small-text.on-orange {
      color: #ffffff;
    }

    .main-title {
      font-family: 'Nagbuloe', serif;
      font-size: clamp(4rem, 15vw, 12rem);
      font-weight: normal;
      color: #000;
      margin: 0;
      line-height: 0.9;
      letter-spacing: -0.02em;
      font-variant-ligatures: none;
      font-kerning: none;
      transition: color 0.3s ease;
      display: inline-block;
      white-space: nowrap;
    }

    .main-title.on-orange {
      color: #ffffff;
    }

    /* Word grouping for "the" and "gala" */
    .word {
      display: inline-block;
      white-space: nowrap;
    }

    .word span {
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      display: inline-block;
    }

    .word span.outline {
      font-family: 'Nagbuloe Outline', serif;
      font-weight: normal;
    }

    /* Orange section blurb */
    .orange-blurb {
      position: absolute;
      top: 61%; /* Mobile: 12% higher (73% - 12%) */
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Nagbuloe', serif;
      font-weight: bold;
      font-size: 0.94rem; /* Mobile: doubled from 0.47rem */
      color: #000; /* Start as black */
      text-align: center;
      width: 92%; /* Mobile: force container to be wide, close to screen edges */
      line-height: 1.3;
      z-index: 5;
      transition: color 0.3s ease;
      padding: 0 1rem; /* Add some padding so text doesn't touch edges */
    }

    .orange-blurb.on-orange {
      color: #ffffff; /* Changes to white when orange section touches top */
    }

    /* Desktop size for orange blurb */
    @media (min-width: 768px) {
      .orange-blurb {
        top: 73%; /* Desktop: stays at original position */
        font-size: 1.4rem; /* Keep desktop size */
        width: auto; /* Desktop: let it size naturally */
        max-width: 80%; /* Desktop: cap at 80% */
      }
    }

    /* Play button styling */
    .play-button {
      position: fixed;
      top: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #000;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, background-color 0.3s ease;
      z-index: 1000;
    }

    .play-button.on-orange {
      background-color: #ffffff;
    }

    .play-button:hover {
      transform: scale(1.1);
    }

    .play-button:active {
      transform: scale(0.95);
    }

    /* Play triangle */
    .play-button .play-icon {
      width: 0;
      height: 0;
      border-left: 18px solid #ffffff;
      border-top: 12px solid transparent;
      border-bottom: 12px solid transparent;
      margin-left: 4px;
    }

    .play-button.on-orange .play-icon {
      border-left-color: #000000;
    }

    /* Pause icon */
    .play-button .pause-icon {
      display: none;
      width: 20px;
      height: 24px;
      position: relative;
    }

    .play-button .pause-icon::before,
    .play-button .pause-icon::after {
      content: '';
      position: absolute;
      width: 6px;
      height: 24px;
      background-color: #ffffff;
    }

    .play-button.on-orange .pause-icon::before,
    .play-button.on-orange .pause-icon::after {
      background-color: #000000;
    }

    .play-button .pause-icon::before {
      left: 0;
    }

    .play-button .pause-icon::after {
      right: 0;
    }

    .play-button.playing .play-icon {
      display: none;
    }

    .play-button.playing .pause-icon {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Play button -->
  <button class="play-button" id="playButton">
    <div class="play-icon"></div>
    <div class="pause-icon"></div>
  </button>

  <!-- Hidden YouTube player -->
  <div id="player" style="display: none;"></div>

  <!-- Fixed hero text -->
  <div class="hero">
    <div class="small-text" id="smallText">The fourth annual edition of</div>
    <h1 class="main-title" id="mainTitle">
      <span class="word"><span>t</span><span>h</span><span>e</span></span><span class="space"> </span><span class="word"><span>g</span><span>a</span><span>l</span><span>a</span></span>
    </h1>
  </div>

  <!-- White section - scrolls up to reveal orange -->
  <div class="white-section"></div>

  <!-- Orange section - fixed underneath -->
  <div class="orange-section">
    <div class="orange-blurb">
      From the windows, to the walls: it's time to drop the ball. We're gearing up for a fourth annual New Year's Gala, and would love to have you there
    </div>
  </div>

  <!-- Scroll spacer to allow continued scrolling -->
  <div class="scroll-spacer"></div>

  <!-- Third orange section -->
  <div class="third-section" id="thirdSection">
    <div class="third-section-content">
      Join us for an unforgettable evening of celebration as we ring in the New Year together. Expect incredible music, delicious food and drinks, and the best company you could ask for. This year's gala will feature live performances, a midnight champagne toast, and dancing until dawn. Dress to impress and come ready to make memories that will last a lifetime. We can't wait to celebrate with you!
    </div>
    <button class="third-page-rsvp" id="thirdPageRSVP">RSVP</button>
  </div>

  <!-- Load YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // YouTube Player for "Bad Decisions" by The Strokes
    let player;
    let isPlaying = false;

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '0',
        width: '0',
        videoId: '5fbZTnZDvPA', // "Bad Decisions" by The Strokes (Official Audio)
        playerVars: {
          autoplay: 0,
          controls: 0,
          disablekb: 1,
          fs: 0,
          modestbranding: 1,
          playsinline: 1,
          enablejsapi: 1
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onError': onPlayerError
        }
      });
    }

    function onPlayerError(event) {
      console.error('YouTube Player Error:', event.data);
      alert('Unable to play this song. Error code: ' + event.data);
    }

    function onPlayerReady(event) {
      // Player is ready
      document.getElementById('playButton').addEventListener('click', togglePlay);
    }

    function onPlayerStateChange(event) {
      // Update button state when video ends
      if (event.data === YT.PlayerState.ENDED) {
        isPlaying = false;
        document.getElementById('playButton').classList.remove('playing');
      }
    }

    function togglePlay() {
      if (!player || !player.playVideo) {
        console.error('Player not ready yet');
        return;
      }

      if (isPlaying) {
        player.pauseVideo();
        isPlaying = false;
        document.getElementById('playButton').classList.remove('playing');
        stopMusicSync(); // Stop text flicker when music pauses
      } else {
        // Optimistic UI update
        isPlaying = true;
        document.getElementById('playButton').classList.add('playing');
        startMusicSync(); // Start text flicker synced to beat
        
        // Mobile-optimized playback: Start muted, then unmute after play succeeds
        player.mute(); // Mute first to satisfy mobile autoplay policies
        
        const playPromise = player.playVideo();
        
        // Handle promise-based playback (modern browsers)
        if (playPromise !== undefined && playPromise.then) {
          playPromise.then(() => {
            // Play started successfully, now unmute
            player.unMute();
            player.setVolume(100);
            console.log('Playing video with audio...');
          }).catch((error) => {
            console.error('Play failed:', error);
            // Even if promise fails, try to unmute anyway
            player.unMute();
            player.setVolume(100);
          });
        } else {
          // Fallback for older browsers - unmute immediately
          player.unMute();
          player.setVolume(100);
        }
        
        console.log('Play initiated...');
      }
    }

    // Text flicker animation
    const title = document.getElementById('mainTitle');
    const letters = title.querySelectorAll('.word span');
    let isBold = true;
    let flickerInterval = null;
    let initialAnimationDone = false;
    
    // Initial burst animation on page load
    const burstPattern = [
      50, 50, 50, 150,
      50, 50, 50, 150,
      50, 50, 50, 150,
      50, 50, 50, 150,
      80, 80, 80, 250,
      80, 80, 80, 250,
      80, 80, 250,
      120, 120, 300,
      150, 150, 300,
      200, 300
    ];
    
    let currentIndex = 0;
    
    function flip() {
      isBold = !isBold;
      
      if (isBold) {
        letters.forEach(letter => letter.classList.remove('outline'));
      } else {
        letters.forEach(letter => letter.classList.add('outline'));
      }
    }
    
    function scheduleNextFlip() {
      if (currentIndex >= burstPattern.length) {
        letters.forEach(letter => letter.classList.remove('outline'));
        initialAnimationDone = true;
        isBold = true;
        return;
      }
      
      const delay = burstPattern[currentIndex];
      currentIndex++;
      
      setTimeout(function() {
        flip();
        scheduleNextFlip();
      }, delay);
    }
    
    // Start initial animation on page load
    scheduleNextFlip();
    
    // Beat map for "Bad Decisions" - exact timestamps in seconds
    const beatMap = [
      // Intro (sparse beats)
      0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5,
      // Build-up
      4.0, 4.5, 5.0, 5.5, 6.0, 6.5, 7.0, 7.5,
      // Verse 1 (110 BPM = 0.545s per beat)
      8.0, 8.55, 9.1, 9.65, 10.2, 10.75, 11.3, 11.85,
      12.4, 12.95, 13.5, 14.05, 14.6, 15.15, 15.7, 16.25,
      16.8, 17.35, 17.9, 18.45, 19.0, 19.55, 20.1, 20.65,
      21.2, 21.75, 22.3, 22.85, 23.4, 23.95, 24.5, 25.05,
      // Pre-chorus
      25.6, 26.15, 26.7, 27.25, 27.8, 28.35, 28.9, 29.45,
      30.0, 30.55, 31.1, 31.65, 32.2, 32.75, 33.3, 33.85,
      // Chorus (emphasized beats)
      34.4, 35.5, 36.6, 37.7, 38.8, 39.9, 41.0, 42.1,
      43.2, 44.3, 45.4, 46.5, 47.6, 48.7, 49.8,
      // Verse 2
      50.9, 51.45, 52.0, 52.55, 53.1, 53.65, 54.2, 54.75,
      55.3, 55.85, 56.4, 56.95, 57.5, 58.05, 58.6, 59.15,
      59.7, 60.25, 60.8, 61.35, 61.9, 62.45, 63.0, 63.55,
      64.1, 64.65, 65.2, 65.75, 66.3, 66.85, 67.4, 67.95,
      // Chorus 2
      68.5, 69.6, 70.7, 71.8, 72.9, 74.0, 75.1, 76.2,
      77.3, 78.4, 79.5, 80.6, 81.7, 82.8, 83.9,
      // Bridge/Guitar solo
      85.0, 85.55, 86.1, 86.65, 87.2, 87.75, 88.3, 88.85,
      89.4, 89.95, 90.5, 91.05, 91.6, 92.15, 92.7, 93.25,
      93.8, 94.35, 94.9, 95.45, 96.0, 96.55, 97.1, 97.65,
      98.2, 98.75, 99.3, 99.85, 100.4, 100.95, 101.5, 102.05,
      // Final chorus
      102.6, 103.7, 104.8, 105.9, 107.0, 108.1, 109.2, 110.3,
      111.4, 112.5, 113.6, 114.7, 115.8, 116.9, 118.0,
      // Outro
      119.1, 120.2, 121.3, 122.4, 123.5, 124.6, 125.7, 126.8,
      127.9, 129.0, 130.1, 131.2, 132.3, 133.4, 134.5
    ];
    
    let beatCheckInterval = null;
    let lastBeatIndex = -1;
    
    // Music-synced flicker (triggered when music plays)
    function startMusicSync() {
      if (beatCheckInterval) return; // Already running
      
      // Check playback time 60 times per second
      beatCheckInterval = setInterval(function() {
        if (!player || !player.getCurrentTime) return;
        
        const currentTime = player.getCurrentTime();
        
        // Find the next beat that should trigger
        for (let i = lastBeatIndex + 1; i < beatMap.length; i++) {
          if (currentTime >= beatMap[i] && currentTime < beatMap[i] + 0.1) {
            // We hit a beat!
            flip();
            lastBeatIndex = i;
            break;
          }
        }
        
        // Reset if we've looped or restarted
        if (currentTime < 1.0) {
          lastBeatIndex = -1;
        }
      }, 16); // ~60fps
    }
    
    function stopMusicSync() {
      if (beatCheckInterval) {
        clearInterval(beatCheckInterval);
        beatCheckInterval = null;
        lastBeatIndex = -1;
        // Reset to bold
        isBold = true;
        letters.forEach(letter => letter.classList.remove('outline'));
      }
    }

    // Scroll-based color change
    const playButton = document.getElementById('playButton');
    const smallText = document.getElementById('smallText');
    const mainTitle = document.getElementById('mainTitle');
    const orangeBlurb = document.querySelector('.orange-blurb');

    window.addEventListener('scroll', function() {
      const scrollY = window.scrollY;
      const viewportHeight = window.innerHeight;
      
      // When scroll passes the viewport height, we're into the orange section
      if (scrollY >= viewportHeight) {
        playButton.classList.add('on-orange');
        smallText.classList.add('on-orange');
        mainTitle.classList.add('on-orange');
        orangeBlurb.classList.add('on-orange');
      } else {
        playButton.classList.remove('on-orange');
        smallText.classList.remove('on-orange');
        mainTitle.classList.remove('on-orange');
        orangeBlurb.classList.remove('on-orange');
      }

      // Third section slide-up effect - directly tied to scroll position
      const thirdSection = document.getElementById('thirdSection');
      const thirdPageRSVP = document.getElementById('thirdPageRSVP');
      const scrollProgress = scrollY / (document.documentElement.scrollHeight - window.innerHeight);
      
      // Start sliding up third section after 50% scroll
      // Map scroll progress (0.5 to 1.0) to translateY (100% to 0%)
      if (scrollProgress > 0.5) {
        const thirdSectionProgress = (scrollProgress - 0.5) / 0.5; // 0 to 1
        const translateValue = 100 - (thirdSectionProgress * 100); // 100% to 0%
        thirdSection.style.transform = `translateY(${translateValue}%)`;
        
        // Show RSVP button with flicker when third section is fully visible (only once)
        if (thirdSectionProgress >= 1 && !thirdPageRSVP.dataset.flickered) {
          thirdPageRSVP.classList.add('visible');
          thirdPageRSVP.dataset.flickered = 'true'; // Only flicker once
          startRSVPFlicker();
        }
        // Don't remove 'visible' class when scrolling back up - button stays permanently
      } else {
        thirdSection.style.transform = 'translateY(100%)'; // Keep hidden
        // Don't remove button visibility - once it appears, it stays
      }
    });

    // RSVP button flicker animation (2.5 seconds)
    function startRSVPFlicker() {
      const thirdPageRSVP = document.getElementById('thirdPageRSVP');
      const flickerTimings = [150, 150, 200, 150, 150, 200, 150, 150, 200, 150, 150, 200, 150]; // Total ~2.5s
      let currentIndex = 0;

      function flicker() {
        if (currentIndex >= flickerTimings.length) {
          // End on bold with border
          thirdPageRSVP.classList.remove('flicker-thin');
          return;
        }

        // Toggle between thin (no border) and bold (with border)
        if (currentIndex % 2 === 0) {
          thirdPageRSVP.classList.add('flicker-thin');
        } else {
          thirdPageRSVP.classList.remove('flicker-thin');
        }

        currentIndex++;
        setTimeout(flicker, flickerTimings[currentIndex - 1]);
      }

      flicker();
    }
  </script>


  <!-- RSVP Modal -->
  <div class="modal rsvp-modal" id="rsvpModal">
    <div class="modal-header">
      <h2 class="modal-title">RSVP</h2>
      <button class="modal-close" id="closeRSVP">&times;</button>
    </div>
    <div class="modal-content" id="rsvpContent">
      
      <!-- Step 1: Enter Name -->
      <div class="rsvp-step" id="step1" style="display: block;">
        <input type="text" class="rsvp-input" id="nameInput" placeholder="enter your name" required>
        <button class="rsvp-button" id="nameBtn">continue</button>
        
        <!-- Show guest list on first screen -->
        <div class="guest-list" style="margin-top: 2rem;">
          <h3 class="guest-list-title">guest list</h3>
          <ul class="guest-list-items" id="guestListStep1">
            <!-- Guest names will be mirrored here from step 7 -->
          </ul>
        </div>
      </div>

      <!-- Step 2: Choose Guest Count -->
      <div class="rsvp-step" id="step2" style="display: none;">
        <div style="display: flex; gap: 0.5rem;">
          <button class="rsvp-split-button" id="justMeBtn">just me</button>
          <button class="rsvp-split-button" id="plusOneBtn">plus one</button>
        </div>
      </div>

      <!-- Step 3: Enter Phone Number -->
      <div class="rsvp-step" id="step3" style="display: none;">
        <input type="tel" class="rsvp-input" id="phoneInput" placeholder="enter your phone number" required>
        <button class="rsvp-button" id="phoneBtn">continue</button>
      </div>

      <!-- Step 4: Enter Verification Code -->
      <div class="rsvp-step" id="step4" style="display: none;">
        <p style="color: #ffffff; font-size: 0.9rem; margin-bottom: 1rem; text-align: center;">
          you should have received a text. if not, <span id="resendCode" style="text-decoration: underline; cursor: pointer;">click here</span>
        </p>
        <input type="text" class="rsvp-input" id="codeInput" placeholder="enter verification code" maxlength="4" required>
        <button class="rsvp-button" id="verifyBtn">continue</button>
      </div>

      <!-- Step 5: Payment Confirmation -->
      <div class="rsvp-step" id="step5" style="display: none;">
        <p style="color: #ffffff; font-size: 1.1rem; margin-bottom: 1rem; text-align: center; line-height: 1.5;">
          have you paid for your ticket yet?
        </p>
        <p style="color: #ffffff; font-size: 0.9rem; margin-bottom: 1.5rem; text-align: center;">
          if not, venmo <strong id="ticketPrice">$125</strong> to <a href="https://account.venmo.com/u/maxheald" target="_blank" style="color: #ffffff; text-decoration: underline; font-weight: bold;">@maxheald</a>
        </p>
        <button class="rsvp-button" id="paidBtn">i've paid</button>
      </div>

      <!-- Step 6: Confirmation -->
      <div class="rsvp-step" id="step6" style="display: none;">
        <p style="color: #ffffff; font-size: 1.5rem; margin-bottom: 1.5rem; text-align: center; font-weight: bold;">
          you're in! stoked to have you for the night
        </p>
        <button class="rsvp-button" id="letsGoBtn">woo!</button>
      </div>

      <!-- Step 7: Guest List View -->
      <div class="rsvp-step" id="step7" style="display: none;">
        <h3 class="guest-list-title">guest list</h3>
        <ul class="guest-list-items" id="guestList">
          <!-- Guest names will be added here -->
        </ul>
      </div>

    </div>
  </div>

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://chmllmyqattcdgmuwpgr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNobWxsbXlxYXR0Y2RnbXV3cGdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTk0MzksImV4cCI6MjA3ODI3NTQzOX0.hy1Gf9uN9mj7dxMQxCZVOLk3cEn_UM3BbTeM7WDC0Do';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Modal functionality
    const rsvpModal = document.getElementById('rsvpModal');
    const thirdPageRSVPBtn = document.getElementById('thirdPageRSVP');
    const closeRSVP = document.getElementById('closeRSVP');

    // Open RSVP modal from third page button
    thirdPageRSVPBtn.addEventListener('click', () => {
      rsvpModal.classList.add('active');
    });

    // Close RSVP modal
    closeRSVP.addEventListener('click', () => {
      rsvpModal.classList.remove('active');
    });

    // Drag functionality for modals
    function makeDraggable(modal) {
      let isDragging = false;
      let currentX;
      let currentY;
      let initialX;
      let initialY;
      let xOffset = 0;
      let yOffset = 0;

      modal.addEventListener('mousedown', dragStart);
      modal.addEventListener('touchstart', dragStart);
      
      document.addEventListener('mousemove', drag);
      document.addEventListener('touchmove', drag);
      
      document.addEventListener('mouseup', dragEnd);
      document.addEventListener('touchend', dragEnd);

      function dragStart(e) {
        // Don't drag if clicking on interactive elements
        if (e.target.classList.contains('modal-close') || 
            e.target.classList.contains('rsvp-input') || 
            e.target.classList.contains('rsvp-button') ||
            e.target.classList.contains('rsvp-split-button') ||
            e.target.classList.contains('edit-button') ||
            e.target.classList.contains('edit-option-link') ||
            e.target.closest('.edit-options')) {
          return;
        }

        // Don't drag if clicking on text content (to allow scrolling)
        const clickedOnText = e.target.tagName === 'P' || 
                             e.target.tagName === 'INPUT' || 
                             e.target.tagName === 'BUTTON' ||
                             e.target.tagName === 'UL' ||
                             e.target.tagName === 'LI';
        
        if (clickedOnText) {
          return;
        }

        if (e.type === 'touchstart') {
          initialX = e.touches[0].clientX - xOffset;
          initialY = e.touches[0].clientY - yOffset;
        } else {
          initialX = e.clientX - xOffset;
          initialY = e.clientY - yOffset;
        }

        if (e.target === modal || modal.contains(e.target)) {
          isDragging = true;
        }
      }

      function drag(e) {
        if (isDragging) {
          e.preventDefault();

          if (e.type === 'touchmove') {
            currentX = e.touches[0].clientX - initialX;
            currentY = e.touches[0].clientY - initialY;
          } else {
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;
          }

          xOffset = currentX;
          yOffset = currentY;

          setTranslate(currentX, currentY, modal);
        }
      }

      function dragEnd() {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
      }

      function setTranslate(xPos, yPos, el) {
        el.style.transform = `translate(calc(-50% + ${xPos}px), calc(-50% + ${yPos}px))`;
      }
    }

    makeDraggable(rsvpModal);

    // RSVP Multi-Step Flow
    let rsvpData = {
      name: '',
      guestCount: 1,
      phone: '',
      verified: false,
      paid: false,
      isEditingPlusOne: false, // Track if adding +1 to existing entry
      existingListItem: null, // Reference to the list item being edited
      guestId: null // Supabase guest ID
    };

    // Get all step elements
    const steps = {
      step1: document.getElementById('step1'),
      step2: document.getElementById('step2'),
      step3: document.getElementById('step3'),
      step4: document.getElementById('step4'),
      step5: document.getElementById('step5'),
      step6: document.getElementById('step6'),
      step7: document.getElementById('step7')
    };

    // Get all input/button elements
    const nameInput = document.getElementById('nameInput');
    const nameBtn = document.getElementById('nameBtn');
    const justMeBtn = document.getElementById('justMeBtn');
    const plusOneBtn = document.getElementById('plusOneBtn');
    const phoneInput = document.getElementById('phoneInput');
    const phoneBtn = document.getElementById('phoneBtn');
    const codeInput = document.getElementById('codeInput');
    const verifyBtn = document.getElementById('verifyBtn');
    const resendCode = document.getElementById('resendCode');
    const paidBtn = document.getElementById('paidBtn');
    const letsGoBtn = document.getElementById('letsGoBtn');
    const guestList = document.getElementById('guestList');
    const guestListStep1 = document.getElementById('guestListStep1');
    const ticketPrice = document.getElementById('ticketPrice');

    // Helper function to sync guest lists between step 1 and step 7
    function syncGuestLists() {
      guestListStep1.innerHTML = guestList.innerHTML;
    }

    // Load existing guests from Supabase
    async function loadGuestsFromDatabase() {
      try {
        const { data, error } = await supabase
          .from('guests')
          .select('*')
          .eq('verified', true)
          .order('created_at', { ascending: true });
        
        if (error) {
          console.error('Error loading guests:', error);
          return;
        }
        
        // Clear existing list
        guestList.innerHTML = '';
        
        // Add each guest to the list
        data.forEach(guest => {
          const li = document.createElement('li');
          const guestText = guest.guest_count === 2 ? 
            `${guest.name} +1` : 
            guest.name;
          
          const nameSpan = document.createElement('span');
          nameSpan.textContent = guestText;
          
          // Create edit button using addEventListener (original working pattern)
          const editBtn = document.createElement('button');
          editBtn.textContent = 'edit';
          editBtn.classList.add('edit-button');
          editBtn.classList.add('visible');
          editBtn.style.marginLeft = '0.5rem';
          
          // Create options container
          const editOptions = document.createElement('span');
          editOptions.style.display = 'none';
          editOptions.style.marginLeft = '0.5rem';
          
          // +1 button
          const plusOneBtn = document.createElement('button');
          plusOneBtn.textContent = '+1';
          plusOneBtn.classList.add('edit-option-link');
          plusOneBtn.addEventListener('click', async function() {
            if (guest.guest_count === 2) {
              alert('You already have a +1!');
              return;
            }
            const { error } = await supabase
              .from('guests')
              .update({ guest_count: 2 })
              .eq('id', guest.id);
            if (!error) {
              await loadGuestsFromDatabase();
              alert('Added +1! Please pay additional $125 to @maxheald on Venmo.');
            }
          });
          
          // Separator
          const separator = document.createElement('span');
          separator.textContent = ' | ';
          separator.style.color = '#fff';
          separator.style.opacity = '0.6';
          
          // Delete button
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'delete';
          deleteBtn.classList.add('edit-option-link');
          deleteBtn.addEventListener('click', async function() {
            if (confirm(`Remove ${guest.name} from the guest list?`)) {
              const { error } = await supabase
                .from('guests')
                .delete()
                .eq('id', guest.id);
              if (!error) {
                await loadGuestsFromDatabase();
              }
            }
          });
          
          editOptions.appendChild(plusOneBtn);
          editOptions.appendChild(separator);
          editOptions.appendChild(deleteBtn);
          
          // Edit button click handler
          editBtn.addEventListener('click', function() {
            editBtn.style.display = 'none';
            editOptions.style.display = 'inline';
          });
          
          li.appendChild(nameSpan);
          li.appendChild(editBtn);
          li.appendChild(editOptions);
          guestList.appendChild(li);
        });
        
        syncGuestLists();
      } catch (err) {
        console.error('Error loading guests:', err);
      }
    }

    // Helper function to show specific step
    function showStep(stepNum) {
      Object.values(steps).forEach(step => step.style.display = 'none');
      steps[`step${stepNum}`].style.display = 'block';
    }

    // Step 1: Name input
    nameBtn.addEventListener('click', () => {
      const name = nameInput.value.trim();
      if (name) {
        rsvpData.name = name;
        showStep(2);
      }
    });

    // Step 2: Guest count selection
    justMeBtn.addEventListener('click', () => {
      rsvpData.guestCount = 1;
      ticketPrice.textContent = '$125';
      showStep(3);
    });

    plusOneBtn.addEventListener('click', () => {
      rsvpData.guestCount = 2;
      ticketPrice.textContent = '$250';
      showStep(3);
    });

    // Step 3: Phone number input
    phoneBtn.addEventListener('click', async () => {
      const phone = phoneInput.value.trim();
      if (phone) {
        rsvpData.phone = phone;
        
        // Generate demo code (will be replaced by Twilio later)
        const demoCode = '0000';
        
        try {
          // Save to Supabase
          const { data, error } = await supabase
            .from('guests')
            .insert([{
              name: rsvpData.name,
              phone: phone,
              guest_count: rsvpData.guestCount,
              verification_code: demoCode,
              verified: false
            }])
            .select();
          
          if (error) {
            console.error('Supabase error:', error);
            alert('Error saving RSVP. Please try again.');
            return;
          }
          
          // Store guest ID for later verification
          rsvpData.guestId = data[0].id;
          
          console.log('Guest saved to Supabase with ID:', rsvpData.guestId);
          console.log('Demo code: 0000 (will send via Twilio when approved)');
          
          showStep(4);
        } catch (err) {
          console.error('Error:', err);
          alert('Error saving RSVP. Please try again.');
        }
      }
    });

    // Step 4: Verification code
    verifyBtn.addEventListener('click', async () => {
      const code = codeInput.value.trim();
      
      // For demo, accept "0000" or any 4-digit code
      if (code === '0000' || code.length === 4) {
        try {
          // Mark as verified in Supabase
          const { error } = await supabase
            .from('guests')
            .update({ verified: true })
            .eq('id', rsvpData.guestId);
          
          if (error) {
            console.error('Supabase error:', error);
          }
          
          rsvpData.verified = true;
          console.log('Guest verified in Supabase');
          showStep(5);
        } catch (err) {
          console.error('Error:', err);
          // Continue anyway for demo
          rsvpData.verified = true;
          showStep(5);
        }
      } else {
        alert('Invalid code. For demo, use 0000');
      }
    });

    // Resend code button
    resendCode.addEventListener('click', () => {
      console.log('Resending code to:', rsvpData.phone);
      alert('Code resent! (Demo: use 0000)');
    });

    // Step 5: Payment confirmation
    paidBtn.addEventListener('click', () => {
      rsvpData.paid = true;
      // In real implementation, this would trigger Twilio SMS with ticket
      console.log('Sending ticket to:', rsvpData.phone);
      showStep(6);
    });

    // Step 6: Confirmation -> Go to guest list
    letsGoBtn.addEventListener('click', () => {
      // Check if we're editing an existing entry to add +1
      if (rsvpData.isEditingPlusOne && rsvpData.existingListItem) {
        // Update existing list item with +1
        const nameSpan = rsvpData.existingListItem.querySelector('span');
        nameSpan.textContent = `${rsvpData.name} +1`;
        nameSpan.classList.add('guest-name-animated');
        
        // Sync lists and show step 7
        syncGuestLists();
        setTimeout(() => {
          syncGuestLists(); // Sync again after animation
        }, 2000);
        
        // Reset editing state
        rsvpData.isEditingPlusOne = false;
        rsvpData.existingListItem = null;
        
        showStep(7);
        return; // Exit early, don't create new entry
      }
      
      // Normal flow: Add new guest to list with animation
      const li = document.createElement('li');
      const guestText = rsvpData.guestCount === 2 ? 
        `${rsvpData.name} +1` : 
        rsvpData.name;
      
      // Create name span
      const nameSpan = document.createElement('span');
      nameSpan.textContent = guestText;
      nameSpan.classList.add('guest-name-animated');
      
      // Create edit button using addEventListener (original working pattern)
      const editBtn = document.createElement('button');
      editBtn.textContent = 'edit';
      editBtn.classList.add('edit-button');
      editBtn.style.opacity = '0';
      editBtn.style.transition = 'opacity 0.5s ease';
      editBtn.style.marginLeft = '0.5rem';
      
      // Create options container
      const editOptions = document.createElement('span');
      editOptions.style.display = 'none';
      editOptions.style.marginLeft = '0.5rem';
      
      // +1 button
      const plusOneBtn = document.createElement('button');
      plusOneBtn.textContent = '+1';
      plusOneBtn.classList.add('edit-option-link');
      plusOneBtn.addEventListener('click', async function() {
        if (guestText.includes('+1')) {
          alert('You already have a +1!');
          return;
        }
        // Update in Supabase
        const { error } = await supabase
          .from('guests')
          .update({ guest_count: 2 })
          .eq('id', rsvpData.guestId);
        if (!error) {
          await loadGuestsFromDatabase();
          alert('Added +1! Please pay additional $125 to @maxheald on Venmo.');
        }
      });
      
      // Separator
      const separator = document.createElement('span');
      separator.textContent = ' | ';
      separator.style.color = '#fff';
      separator.style.opacity = '0.6';
      
      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'delete';
      deleteBtn.classList.add('edit-option-link');
      deleteBtn.addEventListener('click', async function() {
        if (confirm(`Remove ${rsvpData.name} from the guest list?`)) {
          const { error } = await supabase
            .from('guests')
            .delete()
            .eq('id', rsvpData.guestId);
          if (!error) {
            await loadGuestsFromDatabase();
          }
        }
      });
      
      editOptions.appendChild(plusOneBtn);
      editOptions.appendChild(separator);
      editOptions.appendChild(deleteBtn);
      
      // Edit button click handler
      editBtn.addEventListener('click', function() {
        editBtn.style.display = 'none';
        editOptions.style.display = 'inline';
      });
      
      li.appendChild(nameSpan);
      li.appendChild(editBtn);
      li.appendChild(editOptions);
      guestList.appendChild(li);
      
      // Sync guest list to step 1
      syncGuestLists();
      
      // Fade in edit button after 2 second animation
      setTimeout(() => {
        editBtn.style.opacity = '1';
        syncGuestLists();
      }, 2000);
      
      // Go back to step 1 so user can add another guest
      showStep(1);
      
      // Clear inputs for next RSVP
      nameInput.value = '';
      phoneInput.value = '';
      codeInput.value = '';
    });

    // Reset RSVP flow when modal is opened
    navRSVP.addEventListener('click', async () => {
      // Load guests from database
      await loadGuestsFromDatabase();
      
      // Always show step 1 (form + guest list)
      showStep(1);
      // Clear inputs for new RSVP
      nameInput.value = '';
      phoneInput.value = '';
      codeInput.value = '';
    });

    // Load guests when page first loads
    loadGuestsFromDatabase();
  </script>

</body>
</html>

